<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Documentation Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }


        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }


        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }


        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }


        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }


        /* Google Drive Status */
        .gdrive-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }


        .gdrive-status.connected {
            background: rgba(40, 167, 69, 0.8);
        }


        .gdrive-status.disconnected {
            background: rgba(220, 53, 69, 0.8);
        }


        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 3px;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-tab.active {
            background: white;
            color: #2c3e50;
        }


        /* Content Area */
        .content {
            padding: 20px;
            min-height: calc(100vh - 80px);
        }


        /* Common Styles */
        .hidden {
            display: none;
        }


        .stats-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }


        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            display: none;
        }


        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }


        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Filters Section */
        .filters-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .filter-input, .filter-select {
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            min-width: 100px;
        }


        /* Multi-select styles */
        .multi-select-container {
            position: relative;
        }


        .multi-select-display {
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-height: 34px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }


        .multi-select-tag {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }


        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }


        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }


        .multi-select-dropdown.show {
            display: block;
        }


        .multi-select-option {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }


        .multi-select-option:hover {
            background: #f8f9fa;
        }


        .multi-select-option.selected {
            background: #007bff;
            color: white;
        }


        .filter-buttons {
            display: flex;
            gap: 8px;
            grid-column: 1 / -1;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .filter-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .filter-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }


        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }


        /* Inactive item styling */
        .data-table tr.inactive-item {
            background-color: #ffebee !important;
        }


        .data-table tr.inactive-item:hover {
            background-color: #ffcdd2 !important;
        }


        /* Form Styles */
        .form-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }


        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }


        /* Button Styles */
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }


        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }


        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }


        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }


        .modal-content {
            background: white;
            margin: 2% auto;
            max-width: 1200px;
            border-radius: 10px;
            position: relative;
        }


        .modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .modal-body {
            padding: 30px;
        }


        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        /* Badge Styles */
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }


        .badge-primary { background: #007bff; color: white; }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-secondary { background: #6c757d; color: white; }
        .badge-info { background: #17a2b8; color: white; }


        /* No Data State */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-data-icon {
            font-size: 4em;
            color: #ddd;
            margin-bottom: 20px;
        }


        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #000; }
        .notification.info { background: #17a2b8; }


        /* Job Card Styles */
        .job-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }


        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }


        .job-card-actions {
            display: flex;
            gap: 10px;
        }


        /* Custom Table for Job Cards */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }


        .custom-table th,
        .custom-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }


        .custom-table th {
            background: #f8f9fa;
            font-weight: 600;
        }


        /* Table Customization Section */
        .table-customization {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px dashed #007bff;
        }


        .column-manager {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }


        .column-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }


        .column-item .column-name {
            font-weight: 600;
            color: #333;
        }


        .column-item .remove-column {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }


        .add-column-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }


        /* History Entry Styles */
        .history-entry {
            background: white;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }


        .history-entry .timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }


        .history-entry .action {
            font-weight: 600;
            color: #2c3e50;
        }


        .history-entry .details {
            font-size: 14px;
            color: #495057;
            margin-top: 5px;
        }


        /* Select Filter Message */
        .select-filter-message {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }


        /* Wide columns for specific fields */
        .wide-column {
            max-width: 200px !important;
        }


        /* Extra wide for item name in documents */
        .extra-wide-column {
            max-width: 300px !important;
            min-width: 250px !important;
        }


        /* Attachments Section */
        .attachments-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }


        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }


        .attachment-info {
            flex: 1;
        }


        .attachment-name {
            font-weight: 600;
            color: #2c3e50;
        }


        .attachment-type {
            font-size: 11px;
            color: #666;
        }


        .view-file-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-decoration: none;
            display: inline-block;
        }


        .view-file-btn:hover {
            background: #218838;
        }


        /* File Preview Modal */
        .file-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            overflow: auto;
        }


        .file-preview-content {
            background: white;
            margin: 2% auto;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }


        .file-preview-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .file-preview-body {
            padding: 20px;
            max-height: 70vh;
            overflow: auto;
        }


        .file-content {
            width: 100%;
            min-height: 500px;
            border: none;
        }


        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }


        .download-link {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 10px;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px;
                font-size: 10px;
            }


            .header h1 {
                font-size: 1.2em;
            }


            .nav-tab {
                padding: 6px 12px;
                font-size: 11px;
            }


            .modal-content {
                margin: 10px;
                max-width: calc(100% - 20px);
            }


            .action-buttons-group {
                flex-direction: column;
            }


            .action-buttons-group .btn {
                font-size: 10px;
                padding: 4px 8px;
            }
        }


        /* Action Buttons Group for Documents */
        .action-buttons-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }


        .action-buttons-group .btn {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 3px;
        }


        /* NEW: Edit Job Card Modal specific styles */
        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            align-items: end;
        }


        .editable-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }


        .editable-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }


        .editable-table th {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px 8px;
            font-weight: 600;
            font-size: 12px;
            text-align: left;
        }


        .editable-table td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 12px;
        }


        .editable-table input,
        .editable-table select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
        }


        .edit-row-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }


        .edit-file-list {
            max-height: 80px;
            overflow-y: auto;
            font-size: 10px;
        }


        .edit-file-item {
            background: #f8f9fa;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .edit-file-remove {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }


        /* Google Drive specific styles */
        .gdrive-file-link {
            color: #4285f4;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }


        .gdrive-file-link:hover {
            text-decoration: underline;
        }


        .gdrive-sync-status {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }


        .gdrive-sync-status.synced {
            color: #28a745;
        }


        .gdrive-sync-status.syncing {
            color: #ffc107;
        }


        .gdrive-sync-status.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Loading...</div>
        </div>
    </div>


    <div class="container" id="documentationApp">
        <!-- Header -->
        <div class="header">
            <h1>📄 Professional Documentation Management System</h1>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')" id="dashboardTab">📊 Dashboard</button>
                <button class="nav-tab" onclick="showSection('source')" id="sourceTab">🗂️ Source</button>
                <button class="nav-tab" onclick="showSection('documents')" id="documentsTab">📋 Documents</button>
                <button class="nav-tab" onclick="showSection('jobCards')" id="jobCardsTab">💼 Job Cards</button>
                <button class="nav-tab" onclick="showSection('history')" id="historyTab">📜 History</button>
            </div>


            <div class="header-right">
                <div class="gdrive-status disconnected" id="gdriveStatus">
                    <span>🔴 Drive Disconnected</span>
                </div>
                <div class="user-info">
                    <span id="userDisplay">👤 Admin User</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>


        <!-- Content Area -->
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <h2>📊 System Dashboard</h2>
                
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-number" id="totalDocuments">0</div>
                        <div class="stat-label">Total Documents</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalItems">0</div>
                        <div class="stat-label">Items</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalJobCards">0</div>
                        <div class="stat-label">Job Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todayUploads">0</div>
                        <div class="stat-label">Today's Uploads</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="gdriveStorage">0 MB</div>
                        <div class="stat-label">Drive Storage Used</div>
                    </div>
                </div>


                <!-- Google Drive Integration Section -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3>☁️ Google Drive Integration</h3>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="initializeGoogleDrive()" id="connectDriveBtn">
                            🔗 Connect to Google Drive
                        </button>
                        <button class="btn btn-success hidden" onclick="syncAllData()" id="syncDataBtn">
                            🔄 Sync All Data
                        </button>
                        <button class="btn btn-warning" onclick="backupToGoogleDrive()" id="backupBtn" style="display: none;">
                            💾 Backup to Drive
                        </button>
                        <button class="btn btn-info" onclick="restoreFromGoogleDrive()" id="restoreBtn" style="display: none;">
                            📥 Restore from Drive
                        </button>
                    </div>
                    <div id="driveStatus" style="margin-top: 15px; font-size: 14px; color: #666;">
                        <p>Connect to Google Drive to automatically save all your data and files.</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>All uploaded files will be stored in Google Drive</li>
                            <li>System data will be automatically saved</li>
                            <li>Access your files from anywhere</li>
                            <li>Automatic daily backups</li>
                        </ul>
                    </div>
                </div>
            </div>


            <!-- Source Section -->
            <div id="sourceSection" class="hidden">
                <!-- Categories Management -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📁 Categories Management</h2>
                    <button class="btn btn-success" onclick="openCategoryModal()">➕ Add Category</button>
                </div>


                <div class="filters-section">
                    <div class="filter-group">
                        <label>Category Type:</label>
                        <select class="filter-select" id="categoryTypeFilter">
                            <option value="">All Types</option>
                            <option value="certificate">Certificate</option>
                            <option value="documents">Documents</option>
                            <option value="template">Template</option>
                            <option value="media">Media</option>
                            <option value="data">Data</option>
                            <option value="artwork">Artwork</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select class="filter-select" id="categoryStatusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" class="filter-input" id="categorySearchFilter" placeholder="Type to search...">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-button" onclick="applyCategoryFilters()">🔍 Filter</button>
                        <button class="filter-button" onclick="clearCategoryFilters()">🗑️ Clear</button>
                    </div>
                </div>


                <table class="data-table" id="categoriesTable">
                    <thead>
                        <tr>
                            <th>Category Name</th>
                            <th>Type</th>
                            <th>Sub-Category</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Tags</th>
                            <th>Table Columns</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody"></tbody>
                </table>


                <!-- Items Management -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 40px 0 20px 0;">
                    <h2>📦 Items Management</h2>
                    <button class="btn btn-success" onclick="openItemModal()">➕ Add Item</button>
                </div>


                <div class="filters-section">
                    <div class="filter-group">
                        <label>Group:</label>
                        <input type="text" class="filter-input" id="itemGroupFilter" placeholder="Type to filter..." list="groupList">
                        <datalist id="groupList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Brand:</label>
                        <input type="text" class="filter-input" id="itemBrandFilter" placeholder="Type to filter..." list="brandList">
                        <datalist id="brandList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Collection:</label>
                        <input type="text" class="filter-input" id="itemCollectionFilter" placeholder="Type to filter..." list="collectionList">
                        <datalist id="collectionList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Code:</label>
                        <input type="text" class="filter-input" id="itemCodeFilter" placeholder="Type to filter..." list="codeList">
                        <datalist id="codeList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Item Name:</label>
                        <input type="text" class="filter-input" id="itemNameFilter" placeholder="Type to filter..." list="itemNameList">
                        <datalist id="itemNameList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Volume:</label>
                        <input type="text" class="filter-input" id="itemVolumeFilter" placeholder="Type to filter..." list="volumeList">
                        <datalist id="volumeList"></datalist>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-button" onclick="applyItemFilters()">🔍 Filter</button>
                        <button class="filter-button" onclick="clearItemFilters()">🗑️ Clear</button>
                    </div>
                </div>


                <table class="data-table" id="itemsTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th class="wide-column">Item Name</th>
                            <th>Group</th>
                            <th>Brand</th>
                            <th>Collection</th>
                            <th>Volume</th>
                            <th>Country</th>
                            <th>Status</th>
                            <th class="wide-column">Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody"></tbody>
                </table>
            </div>


            <!-- Documents Section -->
            <div id="documentsSection" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📋 Documents Library</h2>
                    <div>
                        <button class="btn btn-primary" onclick="downloadFilteredDocuments()">💾 Download</button>
                        <button class="btn btn-success" onclick="exportFilteredDocuments()">📊 Export</button>
                    </div>
                </div>


                <!-- Main Filters -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Category:</label>
                        <input type="text" class="filter-input" id="docCategoryFilter" placeholder="Type to filter..." list="docCategoryList" onchange="updateDocumentFilters()">
                        <datalist id="docCategoryList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Sub-Category:</label>
                        <input type="text" class="filter-input" id="docSubCategoryFilter" placeholder="Type to filter..." list="docSubCategoryList">
                        <datalist id="docSubCategoryList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Code:</label>
                        <input type="text" class="filter-input" id="docCodeFilter" placeholder="Type to filter..." list="docCodeList">
                        <datalist id="docCodeList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Item:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-display" onclick="toggleMultiSelect('docItemFilter')">
                                <span class="placeholder">Select items...</span>
                            </div>
                            <div class="multi-select-dropdown" id="docItemFilterDropdown">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Brand:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-display" onclick="toggleMultiSelect('docBrandFilter')">
                                <span class="placeholder">Select brands...</span>
                            </div>
                            <div class="multi-select-dropdown" id="docBrandFilterDropdown">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Collection:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-display" onclick="toggleMultiSelect('docCollectionFilter')">
                                <span class="placeholder">Select collections...</span>
                            </div>
                            <div class="multi-select-dropdown" id="docCollectionFilterDropdown">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-button" onclick="applyDocumentFilters()">🔍 Filter</button>
                        <button class="filter-button" onclick="clearDocumentFilters()">🗑️ Clear</button>
                    </div>
                </div>


                <!-- Additional Dynamic Filters -->
                <div id="additionalFilters" class="filters-section hidden">
                    <h4 style="grid-column: 1 / -1; margin-bottom: 10px; color: #2c3e50;">Additional Filters:</h4>
                </div>


                <div id="documentsTableContainer">
                    <div class="select-filter-message">
                        <div class="no-data-icon">🔍</div>
                        <h3>Select Filter</h3>
                        <p>Please apply filters to view documents</p>
                    </div>
                </div>
            </div>


            <!-- Job Cards Section -->
            <div id="jobCardsSection" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>💼 Job Cards</h2>
                    <button class="btn btn-success" onclick="openJobCardModal()">➕ Create New Job Card</button>
                </div>


                <!-- Job Cards Filters -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Job Number:</label>
                        <input type="text" class="filter-input" id="jobCardNumberFilter" placeholder="Type job number..." list="jobNumberList">
                        <datalist id="jobNumberList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>User Name:</label>
                        <input type="text" class="filter-input" id="jobCardUserFilter" placeholder="Type user name..." list="jobUserList">
                        <datalist id="jobUserList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Item Name:</label>
                        <input type="text" class="filter-input" id="jobCardItemNameFilter" placeholder="Type item name..." list="jobItemNameList">
                        <datalist id="jobItemNameList"></datalist>
                    </div>
                    <div class="filter-group">
                        <label>Item Code:</label>
                        <input type="text" class="filter-input" id="jobCardItemCodeFilter" placeholder="Type item code..." list="jobItemCodeList">
                        <datalist id="jobItemCodeList"></datalist>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-button" onclick="applyJobCardFilters()">🔍 Filter</button>
                        <button class="filter-button" onclick="clearJobCardFilters()">🗑️ Clear</button>
                    </div>
                </div>


                <div id="jobCardsList"></div>
            </div>


            <!-- History Section -->
            <div id="historySection" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📜 System History</h2>
                </div>


                <div class="filters-section">
                    <div class="filter-group">
                        <label>Action Type:</label>
                        <select class="filter-select" id="historyActionFilter">
                            <option value="">All Actions</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="upload">Upload</option>
                            <option value="download">Download</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>User:</label>
                        <input type="text" class="filter-input" id="historyUserFilter" placeholder="Type to filter...">
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" class="filter-input" id="historyDateFromFilter">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" class="filter-input" id="historyDateToFilter">
                    </div>
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" class="filter-input" id="historySearchFilter" placeholder="Type to search...">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-button" onclick="applyHistoryFilters()">🔍 Filter</button>
                        <button class="filter-button" onclick="clearHistoryFilters()">🗑️ Clear</button>
                    </div>
                </div>


                <div id="historyList"></div>
            </div>
        </div>
    </div>


    <!-- All existing modals here -->
    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">📁 Add Category</h3>
                <button class="close-btn" onclick="closeCategoryModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Category Name: *</label>
                        <input type="text" id="categoryName" placeholder="Enter category name">
                    </div>
                    <div class="form-group">
                        <label>Category Type: *</label>
                        <select id="categoryType" onchange="updateTableTemplate()">
                            <option value="certificate">Certificate</option>
                            <option value="documents">Documents</option>
                            <option value="template">Template</option>
                            <option value="media">Media</option>
                            <option value="data">Data</option>
                            <option value="artwork">Artwork</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sub-Category:</label>
                        <input type="text" id="categorySubCategory" placeholder="Enter sub-category">
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="categoryStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="categoryDescription" placeholder="Category description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated):</label>
                    <input type="text" id="categoryTags" placeholder="tag1, tag2, tag3">
                </div>
                
                <!-- Table Customization Section -->
                <div class="table-customization">
                    <h4>🛠️ Customize Table Columns for this Category</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                        Define the columns that will be used when creating job cards for this category. 
                        Note: Each category can have only one table design.
                    </p>
                    
                    <div id="columnManager" class="column-manager">
                        <!-- Default columns will be added here -->
                    </div>
                    
                    <div class="add-column-section">
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label>Add New Column:</label>
                                <input type="text" id="newColumnName" placeholder="Enter column name..." style="width: 100%; padding: 8px;">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addTableColumn()">➕ Add Column</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveCategory()">💾 Save Category</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="itemModalTitle">📦 Add Item</h3>
                <button class="close-btn" onclick="closeItemModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Code: *</label>
                        <input type="text" id="itemCode" placeholder="e.g., ABC-001">
                    </div>
                    <div class="form-group">
                        <label>Item Name: *</label>
                        <input type="text" id="itemName" placeholder="e.g., Product Name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Group Name: *</label>
                        <input type="text" id="itemGroup" placeholder="e.g., Electronics">
                    </div>
                    <div class="form-group">
                        <label>Brand Name: *</label>
                        <input type="text" id="itemBrand" placeholder="e.g., Samsung">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Collection Name:</label>
                        <input type="text" id="itemCollection" placeholder="e.g., Galaxy Series">
                    </div>
                    <div class="form-group">
                        <label>Volume:</label>
                        <input type="text" id="itemVolume" placeholder="e.g., 500ml">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Country:</label>
                        <input type="text" id="itemCountry" placeholder="e.g., UAE">
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="itemStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="itemDescription" placeholder="Item description..."></textarea>
                </div>
                <div class="form-buttons">
                    <button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveItem()">💾 Save Item</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Job Card Modal -->
    <div class="modal" id="jobCardModal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h3>💼 Create New Job Card</h3>
                <button class="close-btn" onclick="closeJobCardModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Select Category: *</label>
                        <select id="jobCardCategory" onchange="updateJobCardSubCategories()">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sub-Category:</label>
                        <select id="jobCardSubCategory">
                            <option value="">Select Sub-Category</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Upload Spreadsheet (Bulk Items):</label>
                    <input type="file" id="jobCardBulkFile" accept=".xlsx,.xls,.csv" onchange="processBulkFile()">
                    <small style="color: #666;">Upload spreadsheet with data for bulk processing</small>
                </div>


                <div class="form-group">
                    <label>Data Table:</label>
                    <div style="overflow-x: auto;">
                        <table class="custom-table" id="jobCardTable">
                            <thead id="jobCardTableHeader">
                                <!-- Headers will be generated dynamically -->
                            </thead>
                            <tbody id="jobCardTableBody">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addJobCardRow()" style="margin-top: 10px;">➕ Add Row</button>
                </div>


                <div class="form-buttons">
                    <button class="btn btn-secondary" onclick="closeJobCardModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveJobCard()">💾 Create Job Card</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Job Card Modal -->
    <div class="modal" id="editJobCardModal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h3 id="editJobCardModalTitle">✏️ Edit Job Card</h3>
                <button class="close-btn" onclick="closeEditJobCardModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Job Card Basic Info -->
                <div class="edit-form-row">
                    <div class="form-group">
                        <label>Job Number:</label>
                        <input type="text" id="editJobNumber" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="editJobStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>


                <div class="edit-form-row">
                    <div class="form-group">
                        <label>Category:</label>
                        <input type="text" id="editJobCategory" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>Sub-Category:</label>
                        <input type="text" id="editJobSubCategory" placeholder="Enter sub-category">
                    </div>
                </div>


                <!-- Editable Data Table -->
                <div class="form-group">
                    <label>Job Card Data:</label>
                    <div class="editable-table-container">
                        <table class="editable-table" id="editJobCardTable">
                            <thead id="editJobCardTableHeader">
                                <!-- Headers will be generated dynamically -->
                            </thead>
                            <tbody id="editJobCardTableBody">
                                <!-- Rows will be populated from job card data -->
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addEditJobCardRow()" style="margin-top: 10px;">➕ Add Row</button>
                </div>


                <div class="form-buttons">
                    <button class="btn btn-secondary" onclick="closeEditJobCardModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveEditJobCard()">💾 Save Changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Document View Modal -->
    <div class="modal" id="documentViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="documentViewTitle">📄 Document Details</h3>
                <button class="close-btn" onclick="closeDocumentViewModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="documentViewContent">
                    <!-- Document details will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Document Edit Modal -->
    <div class="modal" id="documentEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="documentEditTitle">✏️ Edit Document Status</h3>
                <button class="close-btn" onclick="closeDocumentEditModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="documentEditContent">
                    <!-- Document edit form will be populated here -->
                </div>
                <div class="form-buttons">
                    <button class="btn btn-secondary" onclick="closeDocumentEditModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveDocumentEdit()">💾 Save Changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- File Preview Modal -->
    <div class="file-preview-modal" id="filePreviewModal">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <h3 id="filePreviewTitle">📄 File Preview</h3>
                <button class="close-btn" onclick="closeFilePreview()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div class="file-preview-body">
                <div class="file-info" id="fileInfo">
                    <!-- File information will be displayed here -->
                </div>
                <div id="filePreviewContent">
                    <!-- File preview will be displayed here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Load Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Google Drive API Configuration
        const GOOGLE_DRIVE_CONFIG = {
            CLIENT_ID: '1042799843395-eq073d2ddu1db3uelsn7tiav8n5feq67.apps.googleusercontent.com',            API_KEY: 'AIzaSyDJqE22Qlkxvh-EBM-5gJMV6x7xphzyuNg',            
DISCOVERYDOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            SCOPES: 'https://www.googleapis.com/auth/drive.file'
        };


        // Google Drive Integration Variables
        let gapi;
        let googleDriveInitialized = false;
        let googleDriveAuthorized = false;
        let documentationSystemFolderId = null;
        let systemDataFileId = null;


        // Global Variables (keeping all existing ones)
        let currentUser = {
            id: 'USER001',
            name: 'System Administrator',
            role: 'admin'
        };


        // Data Storage (keeping existing structure)
        let systemData = {
            categories: [],
            items: [],
            documents: [],
            jobCards: [],
            history: [],
            files: {} // Store file content for preview
        };


        // Filter variables (keeping existing)
        let filteredCategories = [];
        let filteredItems = [];
        let filteredDocuments = [];
        let filteredHistory = [];
        let filteredJobCards = [];


        // Modal states (keeping existing)
        let isEditingCategory = false;
        let editingCategoryId = null;
        let isEditingItem = false;
        let editingItemId = null;
        let editingDocumentId = null;
        let isEditingJobCard = false;
        let editingJobCardId = null;


        // Multi-select variables (keeping existing)
        let multiSelectData = {
            docItemFilter: [],
            docBrandFilter: [],
            docCollectionFilter: []
        };


        // Template columns for different category types (keeping existing)
        const defaultTableTemplates = {
            certificate: ['Code', 'Item', 'Collection', 'Issued By', 'Beneficiary', 'Date of Issuance', 'Date of Expiry', 'Files'],
            artwork: ['Code', 'Item', 'Collection', 'Made by', 'Files'],
            documents: ['Code', 'Item', 'Collection', 'Document Type', 'Version', 'Files'],
            template: ['Code', 'Item', 'Collection', 'Template Type', 'Files'],
            media: ['Code', 'Item', 'Collection', 'Media Type', 'Resolution', 'Files'],
            data: ['Code', 'Item', 'Collection', 'Data Type', 'Format', 'Files'],
            others: ['Code', 'Item', 'Collection', 'Type', 'Files']
        };


        // ========================================
        // GOOGLE DRIVE INTEGRATION FUNCTIONS
        // ========================================


        /**
         * Initialize Google Drive API
         */
     async function initializeGoogleDrive() {
    showLoading('Connecting to Google Drive...');
    
    try {
        // Wait for Google API to load
        if (typeof gapi === 'undefined') {
            throw new Error('Google API not loaded');
        }


        // Load Google API client and auth2
        await new Promise((resolve, reject) => {
            gapi.load('client:auth2', {
                callback: resolve,
                onerror: reject
            });
        });


        // Initialize the client - FIXED: Use correct initialization
        await gapi.client.init({
            apiKey: GOOGLE_DRIVE_CONFIG.API_KEY,
            clientId: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
            discoveryDocs: [GOOGLE_DRIVE_CONFIG.DISCOVERY_DOC],
            scope: GOOGLE_DRIVE_CONFIG.SCOPES
        });


        googleDriveInitialized = true;


        // Check if user is already signed in
        const authInstance = gapi.auth2.getAuthInstance();
        if (authInstance.isSignedIn.get()) {
            googleDriveAuthorized = true;
            await setupGoogleDriveFolder();
            updateGoogleDriveStatus('connected');
            await loadSystemDataFromDrive();
        } else {
            // Request authorization
            const authResult = await authInstance.signIn();
            googleDriveAuthorized = true;
            await setupGoogleDriveFolder();
            updateGoogleDriveStatus('connected');
            await loadSystemDataFromDrive();
        }


        hideLoading();
        showNotification('Successfully connected to Google Drive!', 'success');
        addHistoryEntry('System', 'google_drive_connect', 'Google Drive connected', 'Successfully connected to Google Drive');


    } catch (error) {
        console.error('Google Drive initialization failed:', error);
        hideLoading();
        
        // Provide more specific error messages
        let errorMessage = 'Failed to connect to Google Drive: ';
        if (error.error === 'popup_blocked_by_browser') {
            errorMessage += 'Popup blocked. Please allow popups and try again.';
        } else if (error.error === 'access_denied') {
            errorMessage += 'Access denied. Please grant permissions and try again.';
        } else if (error.message && error.message.includes('API key')) {
            errorMessage += 'Invalid API key. Please check your configuration.';
        } else if (error.message && error.message.includes('client')) {
            errorMessage += 'Invalid client ID. Please check your configuration.';
        } else {
            errorMessage += error.message || 'Unknown error occurred.';
        }
        
        showNotification(errorMessage, 'error');
        updateGoogleDriveStatus('disconnected');
    }
}


        /**
         * Setup Google Drive folder structure
         */
        async function setupGoogleDriveFolder() {
            try {
                // Check if Documentation System folder exists
                const folderQuery = "name='Documentation System' and mimeType='application/vnd.google-apps.folder' and trashed=false";
                const folderResponse = await gapi.client.drive.files.list({
                    q: folderQuery,
                    spaces: 'drive'
                });


                if (folderResponse.result.files.length > 0) {
                    documentationSystemFolderId = folderResponse.result.files[0].id;
                } else {
                    // Create Documentation System folder
                    const folderMetadata = {
                        name: 'Documentation System',
                        mimeType: 'application/vnd.google-apps.folder'
                    };


                    const folderCreateResponse = await gapi.client.drive.files.create({
                        resource: folderMetadata
                    });


                    documentationSystemFolderId = folderCreateResponse.result.id;
                }


                // Create subfolders
                await createSubfolder('Files', documentationSystemFolderId);
                await createSubfolder('Backups', documentationSystemFolderId);


            } catch (error) {
                console.error('Error setting up Google Drive folder:', error);
                throw error;
            }
        }


        /**
         * Create subfolder in Google Drive
         */
        async function createSubfolder(name, parentId) {
            try {
                const query = `name='${name}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`;
                const response = await gapi.client.drive.files.list({ q: query });


                if (response.result.files.length === 0) {
                    const metadata = {
                        name: name,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [parentId]
                    };


                    await gapi.client.drive.files.create({
                        resource: metadata
                    });
                }
            } catch (error) {
                console.error(`Error creating subfolder ${name}:`, error);
            }
        }


        /**
         * Upload file to Google Drive
         */
        async function uploadFileToGoogleDrive(fileName, fileBlob, metadata = {}) {
            if (!googleDriveAuthorized) {
                throw new Error('Google Drive not authorized');
            }


            try {
                // Get Files subfolder ID
                const filesFolderQuery = `name='Files' and mimeType='application/vnd.google-apps.folder' and '${documentationSystemFolderId}' in parents and trashed=false`;
                const filesFolderResponse = await gapi.client.drive.files.list({ q: filesFolderQuery });
                const filesFolderId = filesFolderResponse.result.files[0]?.id;


                if (!filesFolderId) {
                    throw new Error('Files folder not found');
                }


                // Check if file already exists
                const existingFileQuery = `name='${fileName}' and '${filesFolderId}' in parents and trashed=false`;
                const existingFileResponse = await gapi.client.drive.files.list({ q: existingFileQuery });


                const fileMetadata = {
                    name: fileName,
                    parents: [filesFolderId],
                    description: JSON.stringify(metadata)
                };


                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', fileBlob);


                let uploadResponse;
                if (existingFileResponse.result.files.length > 0) {
                    // Update existing file
                    const fileId = existingFileResponse.result.files[0].id;
                    uploadResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                        },
                        body: form
                    });
                } else {
                    // Create new file
                    uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                        },
                        body: form
                    });
                }


                if (!uploadResponse.ok) {
                    throw new Error(`Upload failed: ${uploadResponse.statusText}`);
                }


                const result = await uploadResponse.json();
                return result;


            } catch (error) {
                console.error('Error uploading file to Google Drive:', error);
                throw error;
            }
        }


        /**
         * Download file from Google Drive
         */
        async function downloadFileFromGoogleDrive(fileId) {
            if (!googleDriveAuthorized) {
                throw new Error('Google Drive not authorized');
            }


            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });


                return response.body;


            } catch (error) {
                console.error('Error downloading file from Google Drive:', error);
                throw error;
            }
        }


        /**
         * Save system data to Google Drive
         */
        async function saveSystemDataToDrive() {
            if (!googleDriveAuthorized) {
                return;
            }


            try {
                const systemDataJson = JSON.stringify({
                    systemData: systemData,
                    currentUser: currentUser,
                    lastSaved: new Date().toISOString(),
                    version: '1.0'
                }, null, 2);


                const blob = new Blob([systemDataJson], { type: 'application/json' });
                
                const metadata = {
                    description: 'Professional Documentation Management System Data',
                    lastModified: new Date().toISOString()
                };


                await uploadFileToGoogleDrive('system_data.json', blob, metadata);
                
                updateGoogleDriveStatus('connected', 'Last saved: ' + new Date().toLocaleTimeString());
                
            } catch (error) {
                console.error('Error saving system data to Drive:', error);
                showNotification('Failed to save data to Google Drive', 'warning');
            }
        }


        /**
         * Load system data from Google Drive
         */
        async function loadSystemDataFromDrive() {
            if (!googleDriveAuthorized) {
                return;
            }


            try {
                showLoading('Loading data from Google Drive...');


                // Get Files subfolder ID
                const filesFolderQuery = `name='Files' and mimeType='application/vnd.google-apps.folder' and '${documentationSystemFolderId}' in parents and trashed=false`;
                const filesFolderResponse = await gapi.client.drive.files.list({ q: filesFolderQuery });
                const filesFolderId = filesFolderResponse.result.files[0]?.id;


                if (!filesFolderId) {
                    hideLoading();
                    loadSampleData(); // Load sample data if no Drive data
                    return;
                }


                // Look for system_data.json
                const dataFileQuery = `name='system_data.json' and '${filesFolderId}' in parents and trashed=false`;
                const dataFileResponse = await gapi.client.drive.files.list({ q: dataFileQuery });


                if (dataFileResponse.result.files.length > 0) {
                    const fileId = dataFileResponse.result.files[0].id;
                    systemDataFileId = fileId;


                    // Download and parse system data
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });


                    const driveData = JSON.parse(response.body);
                    
                    // Restore system data
                    systemData = driveData.systemData || systemData;
                    
                    // Update filtered arrays
                    filteredCategories = [...systemData.categories];
                    filteredItems = [...systemData.items];
                    filteredDocuments = [...systemData.documents];
                    filteredHistory = [...systemData.history];
                    filteredJobCards = [...systemData.jobCards];


                    showNotification(`Data loaded from Google Drive (saved: ${new Date(driveData.lastSaved).toLocaleString()})`, 'success');
                    addHistoryEntry('System', 'data_load', 'Data loaded from Google Drive', `Data restored from backup dated ${new Date(driveData.lastSaved).toLocaleString()}`);


                } else {
                    // No system data found, load sample data
                    loadSampleData();
                    await saveSystemDataToDrive(); // Save initial data to Drive
                }


                hideLoading();


            } catch (error) {
                console.error('Error loading system data from Drive:', error);
                hideLoading();
                showNotification('Failed to load data from Google Drive, using local data', 'warning');
                loadSampleData(); // Fallback to sample data
            }
        }


        /**
         * Sync all data to Google Drive
         */
        async function syncAllData() {
            if (!googleDriveAuthorized) {
                showNotification('Please connect to Google Drive first', 'error');
                return;
            }


            showLoading('Syncing all data to Google Drive...');


            try {
                // Save system data
                await saveSystemDataToDrive();


                // Upload all files
                let uploadedFiles = 0;
                let totalFiles = Object.keys(systemData.files).length;


                for (const [fileName, fileData] of Object.entries(systemData.files)) {
                    try {
                        let blob;
                        if (fileData.originalFile) {
                            blob = fileData.originalFile;
                        } else if (fileData.content instanceof ArrayBuffer) {
                            blob = new Blob([fileData.content], { type: fileData.type });
                        } else if (typeof fileData.content === 'string') {
                            blob = new Blob([fileData.content], { type: fileData.type });
                        } else {
                            continue;
                        }


                        await uploadFileToGoogleDrive(fileName, blob, {
                            originalName: fileName,
                            fileType: fileData.type,
                            uploadedBy: currentUser.name,
                            uploadDate: new Date().toISOString()
                        });


                        uploadedFiles++;


                    } catch (error) {
                        console.error(`Error uploading file ${fileName}:`, error);
                    }
                }


                hideLoading();
                showNotification(`Successfully synced ${uploadedFiles}/${totalFiles} files to Google Drive!`, 'success');
                addHistoryEntry('System', 'sync', 'Data synced to Google Drive', `${uploadedFiles} files and system data synced to Google Drive`);


            } catch (error) {
                console.error('Error syncing data:', error);
                hideLoading();
                showNotification('Failed to sync data: ' + error.message, 'error');
            }
        }


        /**
         * Backup to Google Drive
         */
        async function backupToGoogleDrive() {
            if (!googleDriveAuthorized) {
                showNotification('Please connect to Google Drive first', 'error');
                return;
            }


            showLoading('Creating backup...');


            try {
                // Get Backups subfolder ID
                const backupsFolderQuery = `name='Backups' and mimeType='application/vnd.google-apps.folder' and '${documentationSystemFolderId}' in parents and trashed=false`;
                const backupsFolderResponse = await gapi.client.drive.files.list({ q: backupsFolderQuery });
                const backupsFolderId = backupsFolderResponse.result.files[0]?.id;


                if (!backupsFolderId) {
                    throw new Error('Backups folder not found');
                }


                // Create backup data
                const backupData = {
                    systemData: systemData,
                    currentUser: currentUser,
                    backupDate: new Date().toISOString(),
                    version: '1.0',
                    files: {}
                };


                // Include file data in backup
                for (const [fileName, fileData] of Object.entries(systemData.files)) {
                    if (fileData.content) {
                        let contentForBackup;
                        if (fileData.content instanceof ArrayBuffer) {
                            // Convert ArrayBuffer to base64 for JSON storage
                            const uint8Array = new Uint8Array(fileData.content);
                            contentForBackup = btoa(String.fromCharCode.apply(null, uint8Array));
                        } else {
                            contentForBackup = fileData.content;
                        }


                        backupData.files[fileName] = {
                            type: fileData.type,
                            size: fileData.size,
                            content: contentForBackup,
                            isBase64: fileData.content instanceof ArrayBuffer
                        };
                    }
                }


                const backupJson = JSON.stringify(backupData, null, 2);
                const backupBlob = new Blob([backupJson], { type: 'application/json' });
                
                const backupFileName = `backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                
                // Upload backup to Backups folder
                const form = new FormData();
                const fileMetadata = {
                    name: backupFileName,
                    parents: [backupsFolderId],
                    description: `Complete system backup created on ${new Date().toLocaleString()}`
                };
                
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', backupBlob);


                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                    },
                    body: form
                });


                if (!uploadResponse.ok) {
                    throw new Error(`Backup upload failed: ${uploadResponse.statusText}`);
                }


                hideLoading();
                showNotification(`Backup created successfully: ${backupFileName}`, 'success');
                addHistoryEntry('System', 'backup', 'Backup created', `Complete system backup created: ${backupFileName}`);


            } catch (error) {
                console.error('Error creating backup:', error);
                hideLoading();
                showNotification('Failed to create backup: ' + error.message, 'error');
            }
        }


        /**
         * Restore from Google Drive backup
         */
        async function restoreFromGoogleDrive() {
            if (!googleDriveAuthorized) {
                showNotification('Please connect to Google Drive first', 'error');
                return;
            }


            if (!confirm('This will replace all current data with the backup. Are you sure?')) {
                return;
            }


            showLoading('Restoring from backup...');


            try {
                // Get Backups subfolder ID
                const backupsFolderQuery = `name='Backups' and mimeType='application/vnd.google-apps.folder' and '${documentationSystemFolderId}' in parents and trashed=false`;
                const backupsFolderResponse = await gapi.client.drive.files.list({ q: backupsFolderQuery });
                const backupsFolderId = backupsFolderResponse.result.files[0]?.id;


                if (!backupsFolderId) {
                    throw new Error('Backups folder not found');
                }


                // List backup files
                const backupFilesQuery = `'${backupsFolderId}' in parents and name contains 'backup_' and trashed=false`;
                const backupFilesResponse = await gapi.client.drive.files.list({
                    q: backupFilesQuery,
                    orderBy: 'createdTime desc'
                });


                if (backupFilesResponse.result.files.length === 0) {
                    throw new Error('No backup files found');
                }


                // Use the most recent backup
                const latestBackup = backupFilesResponse.result.files[0];
                
                // Download backup data
                const response = await gapi.client.drive.files.get({
                    fileId: latestBackup.id,
                    alt: 'media'
                });


                const backupData = JSON.parse(response.body);
                
                // Restore system data
                systemData = backupData.systemData;
                
                // Restore files
                if (backupData.files) {
                    systemData.files = {};
                    for (const [fileName, fileData] of Object.entries(backupData.files)) {
                        if (fileData.isBase64) {
                            // Convert base64 back to ArrayBuffer
                            const binaryString = atob(fileData.content);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            systemData.files[fileName] = {
                                type: fileData.type,
                                size: fileData.size,
                                content: bytes.buffer,
                                originalFile: null
                            };
                        } else {
                            systemData.files[fileName] = {
                                type: fileData.type,
                                size: fileData.size,
                                content: fileData.content,
                                originalFile: null
                            };
                        }
                    }
                }


                // Update filtered arrays
                filteredCategories = [...systemData.categories];
                filteredItems = [...systemData.items];
                filteredDocuments = [...systemData.documents];
                filteredHistory = [...systemData.history];
                filteredJobCards = [...systemData.jobCards];


                // Update all displays
                updateAllStatistics();
                renderAllSections();
                updateDataLists();


                hideLoading();
                showNotification(`Data restored from backup: ${latestBackup.name}`, 'success');
                addHistoryEntry('System', 'restore', 'Data restored from backup', `System restored from backup: ${latestBackup.name}`);


            } catch (error) {
                console.error('Error restoring from backup:', error);
                hideLoading();
                showNotification('Failed to restore from backup: ' + error.message, 'error');
            }
        }


        /**
         * Update Google Drive status display
         */
        function updateGoogleDriveStatus(status, message = '') {
            const statusElement = document.getElementById('gdriveStatus');
            const driveStatusElement = document.getElementById('driveStatus');
            const connectBtn = document.getElementById('connectDriveBtn');
            const syncBtn = document.getElementById('syncDataBtn');
            const backupBtn = document.getElementById('backupBtn');
            const restoreBtn = document.getElementById('restoreBtn');


            if (status === 'connected') {
                statusElement.className = 'gdrive-status connected';
                statusElement.innerHTML = `<span>🟢 Drive Connected</span>`;
                
                if (driveStatusElement) {
                    driveStatusElement.innerHTML = `
                        <p style="color: #28a745;"><strong>✅ Connected to Google Drive</strong></p>
                        <p>All your data and files are being automatically saved to Google Drive.</p>
                        ${message ? `<p style="font-size: 12px; color: #666;">${message}</p>` : ''}
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>✅ Automatic file storage</li>
                            <li>✅ Real-time data backup</li>
                            <li>✅ Cross-device synchronization</li>
                            <li>✅ Secure cloud storage</li>
                        </ul>
                    `;
                }


                connectBtn.style.display = 'none';
                syncBtn.classList.remove('hidden');
                backupBtn.style.display = 'inline-block';
                restoreBtn.style.display = 'inline-block';


            } else {
                statusElement.className = 'gdrive-status disconnected';
                statusElement.innerHTML = `<span>🔴 Drive Disconnected</span>`;
                
                if (driveStatusElement) {
                    driveStatusElement.innerHTML = `
                        <p style="color: #dc3545;"><strong>❌ Not connected to Google Drive</strong></p>
                        <p>Connect to Google Drive to automatically save all your data and files.</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>All uploaded files will be stored in Google Drive</li>
                            <li>System data will be automatically saved</li>
                            <li>Access your files from anywhere</li>
                            <li>Automatic daily backups</li>
                        </ul>
                    `;
                }


                connectBtn.style.display = 'inline-block';
                syncBtn.classList.add('hidden');
                backupBtn.style.display = 'none';
                restoreBtn.style.display = 'none';
            }
        }


        // ========================================
        // ENHANCED FILE HANDLING WITH GOOGLE DRIVE
        // ========================================


        /**
         * Enhanced file upload with Google Drive storage
         */
        async function handleFileSelect(event, rowIndex) {
            const files = event.target.files;
            const fileList = document.getElementById(`fileList_${rowIndex}`);
            
            if (fileList) {
                fileList.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = file.name;
                    
                    // Store the original file object
                    systemData.files[fileName] = {
                        type: file.type,
                        content: null,
                        size: file.size,
                        originalFile: file,
                        driveFileId: null,
                        uploadStatus: 'pending'
                    };
                    
                    // Read file content
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        systemData.files[fileName].content = e.target.result;
                        
                        // Upload to Google Drive if connected
                        if (googleDriveAuthorized) {
                            try {
                                const driveFile = await uploadFileToGoogleDrive(fileName, file, {
                                    uploadedBy: currentUser.name,
                                    uploadDate: new Date().toISOString()
                                });
                                
                                systemData.files[fileName].driveFileId = driveFile.id;
                                systemData.files[fileName].uploadStatus = 'uploaded';
                                
                                // Update UI to show uploaded status
                                const fileItem = document.querySelector(`[data-filename="${fileName}"]`);
                                if (fileItem) {
                                    fileItem.querySelector('.gdrive-sync-status').innerHTML = '<span class="gdrive-sync-status synced">✅ Synced to Drive</span>';
                                }
                                
                            } catch (error) {
                                console.error(`Error uploading ${fileName} to Drive:`, error);
                                systemData.files[fileName].uploadStatus = 'error';
                                
                                // Update UI to show error status
                                const fileItem = document.querySelector(`[data-filename="${fileName}"]`);
                                if (fileItem) {
                                    fileItem.querySelector('.gdrive-sync-status').innerHTML = '<span class="gdrive-sync-status error">❌ Upload failed</span>';
                                }
                            }
                        }
                        
                        // Save system data after file upload
                        await saveSystemDataToDrive();
                    };
                    reader.readAsArrayBuffer(file);
                    
                    // Create UI element for file
                    const fileItem = document.createElement('div');
                    fileItem.setAttribute('data-filename', fileName);
                    fileItem.innerHTML = `
                        <span style="font-size: 10px;" title="${file.name}">${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}</span>
                        <button type="button" onclick="removeFileFromList(this, '${fileName}')" style="margin-left: 5px; background: none; border: none; color: red; font-size: 10px;">×</button>
                        <div class="gdrive-sync-status">
                            ${googleDriveAuthorized ? '<span class="gdrive-sync-status syncing">⏳ Uploading...</span>' : '<span class="gdrive-sync-status">Local only</span>'}
                        </div>
                    `;
                    fileList.appendChild(fileItem);
                }
            }
        }


        /**
         * Enhanced file opening with Google Drive links
         */
        function openFile(fileName, attachmentName) {
            console.log(`Opening file: ${fileName}`);
            const fileData = systemData.files[fileName];
            if (!fileData) {
                showNotification('File not found', 'error');
                console.error('File not found:', fileName);
                return;
            }


            try {
                // If file is stored in Google Drive, provide Drive link as well
                if (fileData.driveFileId && googleDriveAuthorized) {
                    const driveUrl = `https://drive.google.com/file/d/${fileData.driveFileId}/view`;
                    
                    if (confirm(`Open file from Google Drive?\n\nClick OK to open from Google Drive, or Cancel to open locally.`)) {
                        window.open(driveUrl, '_blank');
                        showNotification(`Opened from Google Drive: ${attachmentName}`, 'success');
                        addHistoryEntry('Document', 'open', 'File opened from Google Drive', `File "${attachmentName}" was opened from Google Drive`);
                        return;
                    }
                }


                // Existing local file opening logic
                if (fileData.originalFile && fileData.type === 'application/pdf') {
                    const url = URL.createObjectURL(fileData.originalFile);
                    const newWindow = window.open(url, '_blank');
                    
                    if (!newWindow) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = attachmentName;
                        link.click();
                        showNotification(`Downloaded: ${attachmentName} (popup blocked)`, 'info');
                    } else {
                        showNotification(`Opened: ${attachmentName}`, 'success');
                    }
                    
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                    addHistoryEntry('Document', 'open', 'File opened', `File "${attachmentName}" was opened`);
                    return;
                }


                if (fileData.content instanceof ArrayBuffer && fileData.type) {
                    const blob = new Blob([fileData.content], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    const newWindow = window.open(url, '_blank');
                    
                    if (!newWindow) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = attachmentName;
                        link.click();
                        showNotification(`Downloaded: ${attachmentName} (popup blocked)`, 'info');
                    } else {
                        showNotification(`Opened: ${attachmentName}`, 'success');
                    }
                    
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                    addHistoryEntry('Document', 'open', 'File opened', `File "${attachmentName}" was opened`);
                    return;
                }


                if (fileData.type === 'text/html' || fileName.includes('.html')) {
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(fileData.content);
                        newWindow.document.close();
                        newWindow.document.title = attachmentName;
                        showNotification(`Opened: ${attachmentName}`, 'success');
                        addHistoryEntry('Document', 'open', 'File opened', `File "${attachmentName}" was opened`);
                        return;
                    }
                }
                
                if (fileData.type === 'image/svg+xml' || fileName.includes('.svg')) {
                    const dataUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(fileData.content)}`;
                    const newWindow = window.open(dataUrl, '_blank');
                    if (newWindow) {
                        showNotification(`Opened: ${attachmentName}`, 'success');
                        addHistoryEntry('Document', 'open', 'File opened', `File "${attachmentName}" was opened`);
                        return;
                    }
                }


                const blob = createFileBlob(fileName);
                if (!blob) {
                    throw new Error('Could not create blob');
                }
                
                const url = URL.createObjectURL(blob);
                const newWindow = window.open(url, '_blank');
                
                if (!newWindow) {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = attachmentName;
                    link.click();
                    showNotification(`Downloaded: ${attachmentName} (popup blocked)`, 'info');
                } else {
                    showNotification(`Opened: ${attachmentName}`, 'success');
                }
                
                setTimeout(() => URL.revokeObjectURL(url), 10000);
                addHistoryEntry('Document', 'open', 'File opened', `File "${attachmentName}" was opened`);
                
            } catch (error) {
                console.error('Error opening file:', error);
                showNotification('Error opening file: ' + error.message, 'error');
                
                try {
                    downloadFileFromAttachment(fileName, attachmentName);
                    showNotification('Could not open file, downloaded instead', 'info');
                } catch (downloadError) {
                    showNotification('Error opening and downloading file', 'error');
                }
            }
        }


        // ========================================
        // AUTO-SAVE FUNCTIONALITY
        // ========================================


        /**
         * Auto-save data to Google Drive
         */
        let autoSaveTimeout;
        function scheduleAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            autoSaveTimeout = setTimeout(async () => {
                if (googleDriveAuthorized) {
                    try {
                        await saveSystemDataToDrive();
                        console.log('Auto-save completed');
                    } catch (error) {
                        console.error('Auto-save failed:', error);
                    }
                }
            }, 5000); // Save 5 seconds after last change
        }


        // ========================================
        // LOADING AND UTILITY FUNCTIONS
        // ========================================


        function showLoading(message = 'Loading...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }


        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }


        // ========================================
        // ENHANCED SYSTEM INITIALIZATION
        // ========================================


        window.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });


        function initializeSystem() {
            console.log('🚀 Initializing Professional Documentation Management System with Google Drive...');
            
            // Initialize Google Drive status
            updateGoogleDriveStatus('disconnected');
            
            // Load initial data (will be replaced by Drive data if connected)
            loadSampleData();
            updateAllStatistics();
            renderAllSections();
            showSection('dashboard');
            
            document.getElementById('userDisplay').textContent = `👤 ${currentUser.name}`;
            
            addHistoryEntry('System', 'system_start', 'System started', `User ${currentUser.name} logged in`);
            
            console.log('✅ System initialized successfully');
            showNotification('Welcome to Professional Documentation Management System', 'success');
        }


        // ========================================
        // ALL EXISTING FUNCTIONS WITH AUTO-SAVE
        // ========================================


        // Enhanced save functions that trigger auto-save
        function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const type = document.getElementById('categoryType').value;
            const subCategory = document.getElementById('categorySubCategory').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const status = document.getElementById('categoryStatus').value;
            const tags = document.getElementById('categoryTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);


            if (!name) {
                showNotification('Please enter category name', 'error');
                return;
            }


            const columnElements = document.querySelectorAll('.column-name');
            const tableColumns = Array.from(columnElements).map(el => el.textContent);


            if (tableColumns.length < 3) {
                showNotification('Please add at least 3 columns (Code and Files are required)', 'error');
                return;
            }


            const categoryData = {
                id: isEditingCategory ? editingCategoryId : 'cat_' + Date.now(),
                name: name,
                type: type,
                subCategory: subCategory,
                description: description,
                status: status,
                tags: tags,
                tableColumns: tableColumns,
                createdDate: isEditingCategory ? 
                    (systemData.categories.find(c => c.id === editingCategoryId)?.createdDate || new Date().toISOString()) : 
                    new Date().toISOString(),
                createdBy: isEditingCategory ? 
                    (systemData.categories.find(c => c.id === editingCategoryId)?.createdBy || currentUser.name) : 
                    currentUser.name,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser.name
            };


            if (isEditingCategory) {
                const categoryIndex = systemData.categories.findIndex(c => c.id === editingCategoryId);
                if (categoryIndex !== -1) {
                    systemData.categories[categoryIndex] = categoryData;
                    filteredDocuments = [...systemData.documents];
                    addHistoryEntry('Category', 'update', 'Category updated', `Category "${name}" was updated`);
                    showNotification('Category updated successfully! Documents table will reflect changes.', 'success');
                }
            } else {
                systemData.categories.push(categoryData);
                addHistoryEntry('Category', 'create', 'Category created', `Category "${name}" was created`);
                showNotification('Category created successfully!', 'success');
            }


            filteredCategories = [...systemData.categories];
            updateAllStatistics();
            renderAllSections();
            closeCategoryModal();
            
            // Trigger auto-save
            scheduleAutoSave();
        }


        function saveItem() {
            const code = document.getElementById('itemCode').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const group = document.getElementById('itemGroup').value.trim();
            const brand = document.getElementById('itemBrand').value.trim();
            const collection = document.getElementById('itemCollection').value.trim();
            const volume = document.getElementById('itemVolume').value.trim();
            const country = document.getElementById('itemCountry').value.trim();
            const status = document.getElementById('itemStatus').value;
            const description = document.getElementById('itemDescription').value.trim();


            if (!code || !name || !group || !brand) {
                showNotification('Please fill in required fields (Code, Name, Group, Brand)', 'error');
                return;
            }


            const itemData = {
                id: isEditingItem ? editingItemId : 'item_' + Date.now(),
                code: code,
                name: name,
                group: group,
                brand: brand,
                collection: collection,
                volume: volume,
                country: country,
                status: status,
                description: description,
                createdDate: isEditingItem ? 
                    (systemData.items.find(i => i.id === editingItemId)?.createdDate || new Date().toISOString()) : 
                    new Date().toISOString(),
                createdBy: isEditingItem ? 
                    (systemData.items.find(i => i.id === editingItemId)?.createdBy || currentUser.name) : 
                    currentUser.name,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser.name
            };


            if (isEditingItem) {
                const itemIndex = systemData.items.findIndex(i => i.id === editingItemId);
                if (itemIndex !== -1) {
                    systemData.items[itemIndex] = itemData;
                    addHistoryEntry('Item', 'update', 'Item updated', `Item "${code}" was updated`);
                    showNotification('Item updated successfully!', 'success');
                }
            } else {
                systemData.items.push(itemData);
                addHistoryEntry('Item', 'create', 'Item created', `Item "${code}" was created`);
                showNotification('Item created successfully!', 'success');
            }


            filteredItems = [...systemData.items];
            updateAllStatistics();
            updateDataLists();
            renderAllSections();
            closeItemModal();
            
            // Trigger auto-save
            scheduleAutoSave();
        }


        // Update statistics with Google Drive storage info
        function updateAllStatistics() {
            document.getElementById('totalDocuments').textContent = systemData.documents.length;
            document.getElementById('totalCategories').textContent = systemData.categories.length;
            document.getElementById('totalItems').textContent = systemData.items.length;
            document.getElementById('totalJobCards').textContent = systemData.jobCards.length;
            
            const today = new Date().toDateString();
            const todayUploads = systemData.documents.filter(doc => 
                new Date(doc.uploadDate).toDateString() === today
            ).length;
            document.getElementById('todayUploads').textContent = todayUploads;
            
            // Calculate Google Drive storage usage
            let totalStorage = 0;
            Object.values(systemData.files).forEach(file => {
                totalStorage += file.size || 0;
            });
            const storageMB = (totalStorage / (1024 * 1024)).toFixed(2);
            document.getElementById('gdriveStorage').textContent = storageMB + ' MB';
        }


        // ========================================
        // ALL EXISTING FUNCTIONS (KEEPING ORIGINAL FUNCTIONALITY)
        // ========================================


        function loadSampleData() {
            // Load sample categories with table columns
            systemData.categories = [
                {
                    id: 'cat_001',
                    name: 'Free Sale Certificate',
                    type: 'certificate',
                    subCategory: 'Export Certificates',
                    description: 'Free sale certificates for export compliance',
                    status: 'active',
                    tags: ['export', 'compliance', 'legal'],
                    tableColumns: ['Code', 'Item', 'Collection', 'Issued By', 'Beneficiary', 'Date of Issuance', 'Date of Expiry', 'Files'],
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name
                },
                {
                    id: 'cat_002',
                    name: 'Product Documentation',
                    type: 'documents',
                    subCategory: 'Technical Documents',
                    description: 'Technical product documentation and specifications',
                    status: 'active',
                    tags: ['technical', 'specifications'],
                    tableColumns: ['Code', 'Item', 'Collection', 'Document Type', 'Version', 'Files'],
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name
                },
                {
                    id: 'cat_003',
                    name: 'Marketing',
                    type: 'media',
                    subCategory: 'Brand Assets',
                    description: 'Marketing and promotional materials',
                    status: 'active',
                    tags: ['marketing', 'branding'],
                    tableColumns: ['Code', 'Item', 'Collection', 'Media Type', 'Files'],
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name
                }
            ];


            // Load sample items with status
            systemData.items = [
                {
                    id: 'item_001',
                    code: 'PRD-001',
                    name: 'Professional Hair Serum',
                    group: 'Hair Care',
                    brand: 'BeautyPro',
                    collection: 'Professional Series',
                    volume: '100ml',
                    country: 'UAE',
                    status: 'active',
                    description: 'Advanced hair treatment serum for professional use',
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name
                },
                {
                    id: 'item_002',
                    code: 'PRD-002',
                    name: 'Moisturizing Face Cream',
                    group: 'Skin Care',
                    brand: 'GlowSkin',
                    collection: 'Daily Care',
                    volume: '50ml',
                    country: 'UAE',
                    status: 'inactive',
                    description: 'Daily moisturizing cream for all skin types',
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name
                }
            ];


            // Load sample job cards
            systemData.jobCards = [
                {
                    id: 'job_001',
                    jobNumber: 'JOB-2025-001',
                    categoryId: 'cat_003',
                    subCategory: 'Brand Assets',
                    tableColumns: ['Code', 'Item', 'Collection', 'Media Type', 'Files'],
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.name,
                    status: 'active',
                    rows: [
                        {
                            itemId: 'item_001',
                            data: {
                                'Media Type': 'Brochure'
                            }
                        }
                    ]
                }
            ];


            // Create working sample files with proper content
            const htmlCertificateContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Free Sale Certificate</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
        .title { font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { font-size: 16px; color: #666; }
        .content { background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 20px 0; }
        .product-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-item { margin-bottom: 15px; }
        .label { font-weight: bold; color: #2c3e50; }
        .signature { margin-top: 40px; text-align: right; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">🏆 FREE SALE CERTIFICATE</div>
        <div class="subtitle">Export Compliance Document</div>
    </div>
    
    <div class="content">
        <div class="product-info">
            <div>
                <div class="info-item">
                    <span class="label">Product Name:</span><br>
                    Professional Hair Serum
                </div>
                <div class="info-item">
                    <span class="label">Product Code:</span><br>
                    PRD-001
                </div>
                <div class="info-item">
                    <span class="label">Brand:</span><br>
                    BeautyPro
                </div>
            </div>
            <div>
                <div class="info-item">
                    <span class="label">Volume:</span><br>
                    100ml
                </div>
                <div class="info-item">
                    <span class="label">Date of Issuance:</span><br>
                    ${new Date().toLocaleDateString()}
                </div>
                <div class="info-item">
                    <span class="label">Valid Until:</span><br>
                    ${new Date(Date.now() + 365*24*60*60*1000).toLocaleDateString()}
                </div>
            </div>
        </div>
        
        <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 5px;">
            <p><strong>CERTIFICATION:</strong></p>
            <p>This is to certify that the above-mentioned product is freely sold in the UAE market and complies with all applicable regulations and standards for export purposes.</p>
            
            <p>The product has been manufactured, tested, and approved according to UAE health and safety standards.</p>
        </div>
        
        <div class="signature">
            <div style="margin-top: 30px;">
                <strong>Health Authority - UAE</strong><br>
                Regulatory Affairs Department<br>
                <em>Digital Certificate</em>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>This is a sample certificate generated by the Professional Documentation Management System</p>
        <p>Replace this file with your actual certificate using the "Replace Files" feature</p>
    </div>
</body>
</html>`;


            const sampleImageContent = `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="400" height="300" fill="url(#bg)" rx="10"/>
                <rect x="20" y="20" width="360" height="260" fill="white" rx="8" opacity="0.95"/>
                
                <!-- Header -->
                <text x="200" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#2c3e50">
                    📸 Marketing Material
                </text>
                
                <!-- Product Info -->
                <text x="50" y="100" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#007bff">
                    Product: Professional Hair Serum
                </text>
                <text x="50" y="125" font-family="Arial, sans-serif" font-size="14" fill="#666">
                    Code: PRD-002
                </text>
                <text x="50" y="145" font-family="Arial, sans-serif" font-size="14" fill="#666">
                    Brand: GlowSkin - Daily Care Collection
                </text>
                
                <!-- Sample Product Image Placeholder -->
                <rect x="50" y="160" width="120" height="80" fill="#f8f9fa" stroke="#ddd" stroke-width="2" rx="5"/>
                <text x="110" y="190" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#999">
                    Product
                </text>
                <text x="110" y="205" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#999">
                    Image
                </text>
                <text x="110" y="220" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#999">
                    Placeholder
                </text>
                
                <!-- Features -->
                <text x="200" y="180" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#2c3e50">
                    Key Features:
                </text>
                <text x="200" y="200" font-family="Arial, sans-serif" font-size="12" fill="#333">
                    ✓ Advanced moisturizing formula
                </text>
                <text x="200" y="215" font-family="Arial, sans-serif" font-size="12" fill="#333">
                    ✓ Suitable for all skin types
                </text>
                <text x="200" y="230" font-family="Arial, sans-serif" font-size="12" fill="#333">
                    ✓ Daily care routine essential
                </text>
                
                <!-- Footer -->
                <text x="200" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#999">
                    Sample marketing material - Replace with your actual files
                </text>
            </svg>`;


            // Store files with proper handling for browser compatibility
            systemData.files = {
                'Free_Sale_Certificate_PRD-001.pdf': {
                    type: 'text/html',
                    content: htmlCertificateContent,
                    size: htmlCertificateContent.length,
                    originalFile: new File([htmlCertificateContent], 'Free_Sale_Certificate_PRD-001.html', {type: 'text/html'}),
                    driveFileId: null,
                    uploadStatus: 'local'
                },
                'Supporting_Document.docx': {
                    type: 'text/html',
                    content: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Supporting Document</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        .header { border-bottom: 2px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
        .section { margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>📄 Supporting Documentation</h1>
        <p><strong>For:</strong> Professional Hair Serum (PRD-001)</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div class="section">
        <h2>Product Information</h2>
        <div class="info-grid">
            <div>
                <p><strong>Name:</strong> Professional Hair Serum</p>
                <p><strong>Code:</strong> PRD-001</p>
                <p><strong>Manufacturer:</strong> BeautyPro</p>
                <p><strong>Volume:</strong> 100ml</p>
            </div>
            <div>
                <p><strong>Collection:</strong> Professional Series</p>
                <p><strong>Country:</strong> UAE</p>
                <p><strong>Status:</strong> Active</p>
                <p><strong>Type:</strong> Hair Care</p>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Regulatory Information</h2>
        <ul>
            <li>This product complies with UAE cosmetic regulations</li>
            <li>Safe for consumer use when used as directed</li>
            <li>Quality tested and approved by certified laboratories</li>
            <li>Meets international export standards</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>Usage Instructions</h2>
        <p>Apply to clean, damp hair. Distribute evenly from mid-length to ends. Style as desired. For best results, use as part of the complete Professional Series routine.</p>
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
        <p>This is a sample document. Replace with your actual supporting documentation.</p>
    </div>
</body>
</html>`,
                    size: 2048,
                    originalFile: new File([`Sample Word Document Content`], 'Supporting_Document.html', {type: 'text/html'}),
                    driveFileId: null,
                    uploadStatus: 'local'
                },
                'Marketing_Material_PRD-002.jpg': {
                    type: 'image/svg+xml',
                    content: sampleImageContent,
                    size: sampleImageContent.length,
                    originalFile: new File([sampleImageContent], 'Marketing_Material_PRD-002.svg', {type: 'image/svg+xml'}),
                    driveFileId: null,
                    uploadStatus: 'local'
                }
            };


            // Load sample documents with working attachments
            systemData.documents = [
                {
                    id: 'doc_001',
                    name: 'Free_Sale_Certificate_PRD-001.pdf',
                    categoryId: 'cat_001',
                    itemId: 'item_001',
                    fileType: 'PDF',
                    jobCardId: 'job_001',
                    metadata: {
                        'Beneficiary': 'Export Company Ltd',
                        'Issued By': 'Health Authority',
                        'Date of Issuance': '2024-01-15',
                        'Date of Expiry': '2025-01-15'
                    },
                    uploadedBy: currentUser.name,
                    uploadDate: new Date().toISOString(),
                    filePath: 'Free_Sale_Certificate_PRD-001.pdf',
                    attachments: [
                        {
                            id: 'att_001',
                            name: 'Free_Sale_Certificate_PRD-001.pdf',
                            type: 'PDF',
                            url: 'Free_Sale_Certificate_PRD-001.pdf',
                            size: '2.3 KB'
                        },
                        {
                            id: 'att_002',
                            name: 'Supporting_Document.docx',
                            type: 'DOC',
                            url: 'Supporting_Document.docx',
                            size: '1.0 KB'
                        }
                    ]
                },
                {
                    id: 'doc_002',
                    name: 'Marketing_Material_PRD-002.jpg',
                    categoryId: 'cat_003',
                    itemId: 'item_002',
                    fileType: 'IMG',
                    jobCardId: 'job_001',
                    metadata: {
                        'Media Type': 'Product Photo'
                    },
                    uploadedBy: currentUser.name,
                    uploadDate: new Date().toISOString(),
                    filePath: 'Marketing_Material_PRD-002.jpg',
                    attachments: [
                        {
                            id: 'att_003',
                            name: 'Marketing_Material_PRD-002.jpg',
                            type: 'IMG',
                            url: 'Marketing_Material_PRD-002.jpg',
                            size: '2.0 KB'
                        }
                    ]
                }
            ];


            // Initialize filtered arrays
            filteredCategories = [...systemData.categories];
            filteredItems = [...systemData.items];
            filteredDocuments = [...systemData.documents];
            filteredHistory = [...systemData.history];
            filteredJobCards = [...systemData.jobCards];
            
            // Update datalists
            updateDataLists();
            updateJobCardDataLists();
            updateDocumentDataLists();
        }


        // File handling functions (keeping existing functionality)
        function createFileBlob(fileName) {
            const fileData = systemData.files[fileName];
            if (!fileData) {
                console.error('File not found:', fileName);
                return null;
            }


            try {
                if (fileData.originalFile) {
                    return fileData.originalFile.slice();
                }
                
                if (fileData.content instanceof ArrayBuffer) {
                    return new Blob([fileData.content], { type: fileData.type });
                } 
                else if (fileData.content instanceof Uint8Array) {
                    return new Blob([fileData.content], { type: fileData.type });
                }
                else if (typeof fileData.content === 'string' && fileData.content.startsWith('data:')) {
                    const response = fetch(fileData.content);
                    return response.then(res => res.blob());
                }
                else if (typeof fileData.content === 'string') {
                    return new Blob([fileData.content], { type: fileData.type || 'text/plain' });
                }
                else {
                    console.error('Unknown content type:', typeof fileData.content);
                    return null;
                }
            } catch (error) {
                console.error('Error creating blob for file:', fileName, error);
                return null;
            }
        }


        // Navigation Functions (keeping existing)
        function showSection(sectionName) {
            const sections = ['dashboardSection', 'sourceSection', 'documentsSection', 'jobCardsSection', 'historySection'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });


            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));


            const targetSection = sectionName + 'Section';
            document.getElementById(targetSection).classList.remove('hidden');


            const tabMap = {
                'dashboard': 0,
                'source': 1,
                'documents': 2,
                'jobCards': 3,
                'history': 4
            };
            
            if (tabMap[sectionName] !== undefined) {
                tabs[tabMap[sectionName]].classList.add('active');
            }


            switch(sectionName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'source':
                    updateDataLists();
                    break;
                case 'documents':
                    updateDocumentDataLists();
                    renderDocuments();
                    break;
                case 'jobCards':
                    updateJobCardDataLists();
                    renderJobCards();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }


            addHistoryEntry('Navigation', 'section_view', 'Section viewed', `User navigated to ${sectionName} section`);
        }


        function renderDashboard() {
            updateAllStatistics();
        }


        // Update DataLists for autocomplete functionality
        function updateDataLists() {
            const groups = [...new Set(systemData.items.map(item => item.group))];
            const brands = [...new Set(systemData.items.map(item => item.brand))];
            const collections = [...new Set(systemData.items.map(item => item.collection).filter(c => c))];
            const codes = [...new Set(systemData.items.map(item => item.code))];
            const names = [...new Set(systemData.items.map(item => item.name))];
            const volumes = [...new Set(systemData.items.map(item => item.volume).filter(v => v))];


            updateDataList('groupList', groups);
            updateDataList('brandList', brands);
            updateDataList('collectionList', collections);
            updateDataList('codeList', codes);
            updateDataList('itemNameList', names);
            updateDataList('volumeList', volumes);
        }


        function updateDocumentDataLists() {
            const categories = [...new Set(systemData.categories.map(cat => cat.name))];
            const subCategories = [...new Set(systemData.categories.map(cat => cat.subCategory).filter(sc => sc))];
            
            const docItems = systemData.documents.map(doc => {
                const item = systemData.items.find(i => i.id === doc.itemId);
                return item;
            }).filter(item => item);


            const docCodes = [...new Set(docItems.map(item => item.code))];
            const docItemNames = [...new Set(docItems.map(item => item.name))];
            const docBrands = [...new Set(docItems.map(item => item.brand))];
            const docCollections = [...new Set(docItems.map(item => item.collection).filter(c => c))];


            updateDataList('docCategoryList', categories);
            updateDataList('docSubCategoryList', subCategories);
            updateDataList('docCodeList', docCodes);


            updateMultiSelectOptions('docItemFilter', docItemNames);
            updateMultiSelectOptions('docBrandFilter', docBrands);
            updateMultiSelectOptions('docCollectionFilter', docCollections);
        }


        function updateMultiSelectOptions(filterName, options) {
            const dropdown = document.getElementById(filterName + 'Dropdown');
            if (!dropdown) return;


            dropdown.innerHTML = options.map(option => `
                <div class="multi-select-option" onclick="toggleMultiSelectOption('${filterName}', '${option}')">
                    ${option}
                </div>
            `).join('');
        }


        function toggleMultiSelect(filterName) {
            const dropdown = document.getElementById(filterName + 'Dropdown');
            if (!dropdown) return;


            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd.id !== filterName + 'Dropdown') {
                    dd.classList.remove('show');
                }
            });


            dropdown.classList.toggle('show');
        }


        function toggleMultiSelectOption(filterName, option) {
            if (!multiSelectData[filterName]) {
                multiSelectData[filterName] = [];
            }


            const index = multiSelectData[filterName].indexOf(option);
            if (index > -1) {
                multiSelectData[filterName].splice(index, 1);
            } else {
                multiSelectData[filterName].push(option);
            }


            updateMultiSelectDisplay(filterName);
            updateMultiSelectDropdownSelection(filterName);
        }


        function updateMultiSelectDisplay(filterName) {
            const display = document.querySelector(`[onclick="toggleMultiSelect('${filterName}')"]`);
            if (!display) return;


            const selected = multiSelectData[filterName] || [];
            
            if (selected.length === 0) {
                display.innerHTML = '<span class="placeholder">Select ' + filterName.replace('doc', '').replace('Filter', '').toLowerCase() + 's...</span>';
            } else {
                display.innerHTML = selected.map(item => `
                    <span class="multi-select-tag">
                        ${item}
                        <span class="remove" onclick="event.stopPropagation(); removeMultiSelectItem('${filterName}', '${item}')">&times;</span>
                    </span>
                `).join('');
            }
        }


        function updateMultiSelectDropdownSelection(filterName) {
            const dropdown = document.getElementById(filterName + 'Dropdown');
            if (!dropdown) return;


            const selected = multiSelectData[filterName] || [];
            
            dropdown.querySelectorAll('.multi-select-option').forEach(option => {
                if (selected.includes(option.textContent.trim())) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }


        function removeMultiSelectItem(filterName, item) {
            if (!multiSelectData[filterName]) return;


            const index = multiSelectData[filterName].indexOf(item);
            if (index > -1) {
                multiSelectData[filterName].splice(index, 1);
            }


            updateMultiSelectDisplay(filterName);
            updateMultiSelectDropdownSelection(filterName);
        }


        function updateJobCardDataLists() {
            const jobNumbers = [...new Set(systemData.jobCards.map(jc => jc.jobNumber || `JOB-${jc.id}`))];
            const userNames = [...new Set(systemData.jobCards.map(jc => jc.createdBy))];
            
            let itemNames = [];
            let itemCodes = [];
            
            systemData.jobCards.forEach(jobCard => {
                jobCard.rows.forEach(row => {
                    const item = systemData.items.find(i => i.id === row.itemId);
                    if (item) {
                        itemNames.push(item.name);
                        itemCodes.push(item.code);
                    }
                });
            });


            itemNames = [...new Set(itemNames)];
            itemCodes = [...new Set(itemCodes)];


            updateDataList('jobNumberList', jobNumbers);
            updateDataList('jobUserList', userNames);
            updateDataList('jobItemNameList', itemNames);
            updateDataList('jobItemCodeList', itemCodes);
        }


        function updateDataList(listId, values) {
            const datalist = document.getElementById(listId);
            if (datalist) {
                datalist.innerHTML = values.map(value => `<option value="${value}"></option>`).join('');
            }
        }


        // Category Management
        function openCategoryModal() {
            isEditingCategory = false;
            editingCategoryId = null;
            clearCategoryForm();
            document.getElementById('categoryModalTitle').textContent = '📁 Add Category';
            document.getElementById('categoryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            updateTableTemplate();
        }


        function closeCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            clearCategoryForm();
        }


        function clearCategoryForm() {
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryType').value = 'certificate';
            document.getElementById('categorySubCategory').value = '';
            document.getElementById('categoryDescription').value = '';
            document.getElementById('categoryStatus').value = 'active';
            document.getElementById('categoryTags').value = '';
            document.getElementById('columnManager').innerHTML = '';
        }


        function updateTableTemplate() {
            const categoryType = document.getElementById('categoryType').value;
            const columnManager = document.getElementById('columnManager');
            const template = defaultTableTemplates[categoryType] || defaultTableTemplates.others;
            
            columnManager.innerHTML = '';
            
            template.forEach(columnName => {
                addColumnToManager(columnName);
            });
        }


        function addColumnToManager(columnName) {
            const columnManager = document.getElementById('columnManager');
            const columnItem = document.createElement('div');
            columnItem.className = 'column-item';
            columnItem.innerHTML = `
                <span class="column-name">${columnName}</span>
                ${columnName !== 'Code' && columnName !== 'Files' ? 
                    `<button type="button" class="remove-column" onclick="this.parentElement.remove()">Remove</button>` : 
                    `<span style="font-size: 10px; color: #666;">Required</span>`
                }
            `;
            columnManager.appendChild(columnItem);
        }


        function addTableColumn() {
            const newColumnName = document.getElementById('newColumnName').value.trim();
            
            if (!newColumnName) {
                showNotification('Please enter a column name', 'error');
                return;
            }


            const existingColumns = Array.from(document.querySelectorAll('.column-name')).map(el => el.textContent);
            if (existingColumns.includes(newColumnName)) {
                showNotification('Column already exists', 'error');
                return;
            }


            addColumnToManager(newColumnName);
            document.getElementById('newColumnName').value = '';
            showNotification('Column added successfully', 'success');
        }


        function editCategory(categoryId) {
            const category = systemData.categories.find(c => c.id === categoryId);
            if (!category) return;


            isEditingCategory = true;
            editingCategoryId = categoryId;


            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            document.getElementById('categorySubCategory').value = category.subCategory || '';
            document.getElementById('categoryDescription').value = category.description;
            document.getElementById('categoryStatus').value = category.status;
            document.getElementById('categoryTags').value = (category.tags || []).join(', ');


            const columnManager = document.getElementById('columnManager');
            columnManager.innerHTML = '';
            (category.tableColumns || []).forEach(columnName => {
                addColumnToManager(columnName);
            });


            document.getElementById('categoryModalTitle').textContent = '✏️ Edit Category';
            document.getElementById('categoryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }


        function deleteCategory(categoryId) {
            const category = systemData.categories.find(c => c.id === categoryId);
            if (!category) return;


            if (confirm(`Are you sure you want to delete category "${category.name}"?`)) {
                systemData.categories = systemData.categories.filter(c => c.id !== categoryId);
                filteredCategories = [...systemData.categories];
                updateAllStatistics();
                renderAllSections();
                addHistoryEntry('Category', 'delete', 'Category deleted', `Category "${category.name}" was deleted`);
                showNotification('Category deleted successfully', 'warning');
                scheduleAutoSave();
            }
        }


        function renderCategories() {
            const tbody = document.getElementById('categoriesTableBody');
            
            if (filteredCategories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            <div class="no-data-icon">📁</div>
                            <div>No categories found</div>
                        </td>
                    </tr>
                `;
                return;
            }


            tbody.innerHTML = filteredCategories.map(category => {
                const typeColors = {
                    'certificate': 'success',
                    'documents': 'primary',
                    'template': 'warning',
                    'media': 'secondary',
                    'data': 'info',
                    'artwork': 'danger',
                    'others': 'secondary'
                };
                
                const tableColumnsPreview = (category.tableColumns || []).slice(0, 3).join(', ') + 
                    (category.tableColumns && category.tableColumns.length > 3 ? '...' : '');
                
                return `
                    <tr>
                        <td><strong>${category.name}</strong></td>
                        <td><span class="badge badge-${typeColors[category.type] || 'primary'}">${category.type}</span></td>
                        <td>${category.subCategory || '-'}</td>
                        <td title="${category.description}">${category.description.length > 30 ? category.description.substring(0, 30) + '...' : category.description}</td>
                        <td><span class="badge badge-${category.status === 'active' ? 'success' : 'secondary'}">${category.status}</span></td>
                        <td>${(category.tags || []).join(', ')}</td>
                        <td title="${(category.tableColumns || []).join(', ')}">${tableColumnsPreview}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editCategory('${category.id}')" title="Edit">✏️</button>
                            <button class="btn btn-danger" onclick="deleteCategory('${category.id}')" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }


        // Item Management
        function openItemModal() {
            isEditingItem = false;
            editingItemId = null;
            clearItemForm();
            document.getElementById('itemModalTitle').textContent = '📦 Add Item';
            document.getElementById('itemModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }


        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            clearItemForm();
        }


        function clearItemForm() {
            const fields = ['itemCode', 'itemName', 'itemGroup', 'itemBrand', 'itemCollection', 'itemVolume', 'itemCountry', 'itemDescription'];
            fields.forEach(field => {
                document.getElementById(field).value = '';
            });
            document.getElementById('itemStatus').value = 'active';
        }


        function editItem(itemId) {
            const item = systemData.items.find(i => i.id === itemId);
            if (!item) return;


            isEditingItem = true;
            editingItemId = itemId;


            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemGroup').value = item.group;
            document.getElementById('itemBrand').value = item.brand;
            document.getElementById('itemCollection').value = item.collection || '';
            document.getElementById('itemVolume').value = item.volume || '';
            document.getElementById('itemCountry').value = item.country || '';
            document.getElementById('itemStatus').value = item.status || 'active';
            document.getElementById('itemDescription').value = item.description || '';


            document.getElementById('itemModalTitle').textContent = '✏️ Edit Item';
            document.getElementById('itemModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }


        function deleteItem(itemId) {
            const item = systemData.items.find(i => i.id === itemId);
            if (!item) return;


            if (confirm(`Are you sure you want to delete item "${item.code}"?`)) {
                systemData.items = systemData.items.filter(i => i.id !== itemId);
                filteredItems = [...systemData.items];
                updateAllStatistics();
                updateDataLists();
                renderAllSections();
                addHistoryEntry('Item', 'delete', 'Item deleted', `Item "${item.code}" was deleted`);
                showNotification('Item deleted successfully', 'warning');
                scheduleAutoSave();
            }
        }


        function renderItems() {
            const tbody = document.getElementById('itemsTableBody');
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="no-data">
                            <div class="no-data-icon">📦</div>
                            <div>No items found</div>
                        </td>
                    </tr>
                `;
                return;
            }


            tbody.innerHTML = filteredItems.map(item => {
                const rowClass = item.status === 'inactive' ? 'inactive-item' : '';
                return `
                    <tr class="${rowClass}">
                        <td><strong>${item.code}</strong></td>
                        <td class="wide-column" title="${item.name}">${item.name}</td>
                        <td>${item.group}</td>
                        <td>${item.brand}</td>
                        <td>${item.collection || '-'}</td>
                        <td>${item.volume || '-'}</td>
                        <td>${item.country || '-'}</td>
                        <td><span class="badge badge-${item.status === 'active' ? 'success' : 'secondary'}">${item.status || 'active'}</span></td>
                        <td class="wide-column" title="${item.description || ''}">${item.description ? (item.description.length > 30 ? item.description.substring(0, 30) + '...' : item.description) : '-'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editItem('${item.id}')" title="Edit">✏️</button>
                            <button class="btn btn-danger" onclick="deleteItem('${item.id}')" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }


        // Utility Functions
        function getFileType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'PDF';
                case 'doc':
                case 'docx': return 'DOC';
                case 'xls':
                case 'xlsx': return 'XLS';
                case 'jpg':
                case 'jpeg':
                case 'png': return 'IMG';
                default: return 'FILE';
            }
        }


        function addHistoryEntry(type, action, summary, details) {
            const entry = {
                id: 'hist_' + Date.now(),
                type: type,
                action: action,
                summary: summary,
                details: details,
                user: currentUser.name,
                timestamp: new Date().toISOString()
            };
            
            systemData.history.push(entry);
            
            if (systemData.history.length > 1000) {
                systemData.history = systemData.history.slice(-1000);
            }
            
            filteredHistory = [...systemData.history];
            scheduleAutoSave();
        }


        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }


        function renderAllSections() {
            renderCategories();
            renderItems();
            renderDocuments();
            renderJobCards();
            renderHistory();
        }


        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                addHistoryEntry('System', 'logout', 'User logout', `User ${currentUser.name} logged out`);
                showNotification('Logged out successfully', 'info');
                
                setTimeout(() => {
                    alert('Redirecting to login page...');
                    window.location.reload();
                }, 1000);
            }
        }


        // Document Management Functions
        function updateDocumentFilters() {
            const selectedCategory = document.getElementById('docCategoryFilter').value.trim();
            const additionalFilters = document.getElementById('additionalFilters');
            
            if (selectedCategory) {
                const category = systemData.categories.find(c => c.name.toLowerCase().includes(selectedCategory.toLowerCase()));
                
                if (category && category.tableColumns) {
                    const additionalColumns = category.tableColumns.filter(col => 
                        !['Code', 'Item', 'Collection', 'Files'].includes(col)
                    );
                    
                    if (additionalColumns.length > 0) {
                        additionalFilters.innerHTML = `
                            <h4 style="grid-column: 1 / -1; margin-bottom: 10px; color: #2c3e50;">Additional Filters:</h4>
                            ${additionalColumns.map(column => `
                                <div class="filter-group">
                                    <label>${column}:</label>
                                    <input type="text" class="filter-input" id="additional_${column.replace(/\s+/g, '_')}" placeholder="Type to filter..." list="${column.replace(/\s+/g, '_')}List">
                                    <datalist id="${column.replace(/\s+/g, '_')}List"></datalist>
                                </div>
                            `).join('')}
                        `;
                        additionalFilters.classList.remove('hidden');
                        
                        additionalColumns.forEach(column => {
                            const values = systemData.documents
                                .filter(doc => doc.metadata && doc.metadata[column])
                                .map(doc => doc.metadata[column])
                                .filter((value, index, self) => self.indexOf(value) === index);
                            
                            updateDataList(`${column.replace(/\s+/g, '_')}List`, values);
                        });
                    } else {
                        additionalFilters.classList.add('hidden');
                    }
                } else {
                    additionalFilters.classList.add('hidden');
                }
            } else {
                additionalFilters.classList.add('hidden');
            }
        }


        function renderDocuments() {
            const container = document.getElementById('documentsTableContainer');
            
            const hasFilters = checkDocumentFilters();
            
            if (!hasFilters) {
                container.innerHTML = `
                    <div class="select-filter-message">
                        <div class="no-data-icon">🔍</div>
                        <h3>Select Filter</h3>
                        <p>Please apply filters to view documents</p>
                    </div>
                `;
                return;
            }


            if (filteredDocuments.length === 0) {
                container.innerHTML = `
                    <div class="select-filter-message">
                        <div class="no-data-icon">📄</div>
                        <h3>No documents found</h3>
                        <p>No documents match the applied filters</p>
                    </div>
                `;
                return;
            }


            let additionalColumns = [];
            if (filteredDocuments.length > 0) {
                const firstDoc = filteredDocuments[0];
                const category = systemData.categories.find(c => c.id === firstDoc.categoryId);
                if (category && category.tableColumns) {
                    additionalColumns = category.tableColumns.filter(col => 
                        !['Code', 'Item', 'Collection', 'Files'].includes(col)
                    );
                }
            }


            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Job Card No.</th>
                            <th>Category</th>
                            <th>Sub-Category</th>
                            <th>Item Code</th>
                            <th class="extra-wide-column">Item Name</th>
                            ${additionalColumns.map(col => `<th>${col}</th>`).join('')}
                            <th>File Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredDocuments.map(doc => {
                            const category = systemData.categories.find(c => c.id === doc.categoryId);
                            const item = systemData.items.find(i => i.id === doc.itemId);
                            const jobCard = systemData.jobCards.find(jc => jc.id === doc.jobCardId);
                            const jobNumber = jobCard ? (jobCard.jobNumber || `JOB-${jobCard.id}`) : '-';
                            
                            const rowClass = item && item.status === 'inactive' ? 'inactive-item' : '';
                            
                            return `
                                <tr class="${rowClass}">
                                    <td>${jobNumber}</td>
                                    <td>${category ? category.name : 'Unknown'}</td>
                                    <td>${category?.subCategory || '-'}</td>
                                    <td>${item ? item.code : 'Unknown'}</td>
                                    <td class="extra-wide-column" title="${item ? item.name : 'Unknown'}">${item ? item.name : 'Unknown'}</td>
                                    ${additionalColumns.map(col => `<td>${doc.metadata && doc.metadata[col] ? doc.metadata[col] : '-'}</td>`).join('')}
                                    <td><span class="badge badge-primary">${doc.fileType}</span></td>
                                   
                                    <td>
                                        <div class="action-buttons-group">
                                            <button class="btn btn-primary" onclick="viewDocument('${doc.id}')" title="View Details">👁️ View</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }


        function checkDocumentFilters() {
            const mainFilters = [
                'docCategoryFilter', 'docSubCategoryFilter', 'docCodeFilter'
            ];
            
            const hasMainFilters = mainFilters.some(filterId => {
                const element = document.getElementById(filterId);
                return element && element.value.trim() !== '';
            });


            const hasMultiSelectFilters = Object.values(multiSelectData).some(arr => arr.length > 0);


            const additionalFilterInputs = document.querySelectorAll('#additionalFilters input[type="text"]');
            const hasAdditionalFilters = Array.from(additionalFilterInputs).some(input => input.value.trim() !== '');
            
            return hasMainFilters || hasMultiSelectFilters || hasAdditionalFilters;
        }


        function viewDocument(docId) {
            const doc = systemData.documents.find(d => d.id === docId);
            if (!doc) return;
            
            const category = systemData.categories.find(c => c.id === doc.categoryId);
            const item = systemData.items.find(i => i.id === doc.itemId);
            const jobCard = systemData.jobCards.find(jc => jc.id === doc.jobCardId);
            
            let attachmentsHtml = '';
            if (doc.attachments && doc.attachments.length > 0) {
                attachmentsHtml = `
                    <div class="attachments-section">
                        <h4>📎 Attachments (${doc.attachments.length})</h4>
                        ${doc.attachments.map(attachment => {
                            // Check if file is stored in Google Drive
                            const fileData = systemData.files[attachment.url];
                            const driveLink = fileData && fileData.driveFileId ? 
                                `https://drive.google.com/file/d/${fileData.driveFileId}/view` : null;
                            
                            return `
                                <div class="attachment-item">
                                    <div class="attachment-info">
                                        <div class="attachment-name">${attachment.name}</div>
                                        <div class="attachment-type">Type: ${attachment.type} | Size: ${attachment.size || 'Unknown'}</div>
                                        ${driveLink ? `<div class="gdrive-sync-status synced">☁️ Available in Google Drive</div>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-direction: column;">
                                        <div>
                                            <button onclick="previewFile('${attachment.url}', '${attachment.name}')" class="view-file-btn">
                                                👁️ Preview
                                            </button>
                                            <button onclick="downloadFileFromAttachment('${attachment.url}', '${attachment.name}')" class="view-file-btn" style="background: #007bff;">
                                                💾 Download
                                            </button>
                                        </div>
                                        ${driveLink ? `
                                            <a href="${driveLink}" target="_blank" class="gdrive-file-link" style="font-size: 11px;">
                                                ☁️ Open in Google Drive
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Document Information</h4>
                        <p><strong>File Name:</strong> ${doc.name}</p>
                        <p><strong>File Type:</strong> ${doc.fileType}</p>
                        <p><strong>Category:</strong> ${category ? category.name : 'Unknown'}</p>
                        <p><strong>Sub-Category:</strong> ${category?.subCategory || '-'}</p>
                        <p><strong>Job Card:</strong> ${jobCard ? (jobCard.jobNumber || jobCard.id) : '-'}</p>
                        <p><strong>File Path:</strong> ${doc.filePath || '-'}</p>
                    </div>
                    <div>
                        <h4>Item Details</h4>
                        <p><strong>Item Code:</strong> ${item ? item.code : 'Unknown'}</p>
                        <p><strong>Item Name:</strong> ${item ? item.name : 'Unknown'}</p>
                        <p><strong>Item Status:</strong> <span class="badge badge-${item && item.status === 'active' ? 'success' : 'secondary'}">${item ? (item.status || 'active') : 'Unknown'}</span></p>
                        <p><strong>Brand:</strong> ${item ? item.brand : '-'}</p>
                        <p><strong>Collection:</strong> ${item ? (item.collection || '-') : '-'}</p>
                        <p><strong>Group:</strong> ${item ? item.group : '-'}</p>
                        <p><strong>Description:</strong> ${item ? (item.description || '-') : '-'}</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>Upload Information</h4>
                    <p><strong>Uploaded By:</strong> ${doc.uploadedBy}</p>
                    <p><strong>Upload Date:</strong> ${new Date(doc.uploadDate).toLocaleString()}</p>
                </div>
                
                ${doc.metadata && Object.keys(doc.metadata).length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h4>Additional Data</h4>
                        ${Object.entries(doc.metadata).map(([key, value]) => 
                            `<p><strong>${key}:</strong> ${value}</p>`
                        ).join('')}
                    </div>
                ` : ''}
                
                ${attachmentsHtml}
            `;
            
            document.getElementById('documentViewContent').innerHTML = content;
            document.getElementById('documentViewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            addHistoryEntry('Document', 'view', 'Document viewed', `Document "${doc.name}" was viewed`);
        }


        function closeDocumentViewModal() {
            document.getElementById('documentViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }


        function previewFile(fileName, attachmentName) {
            const fileData = systemData.files[fileName];
            if (!fileData) {
                showNotification('File not found', 'error');
                return;
            }


            document.getElementById('filePreviewTitle').textContent = `📄 ${attachmentName}`;
            
            const fileInfo = document.getElementById('fileInfo');
            const driveLink = fileData.driveFileId ? 
                `https://drive.google.com/file/d/${fileData.driveFileId}/view` : null;
            
            fileInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p><strong>File Name:</strong> ${attachmentName}</p>
                        <p><strong>File Type:</strong> ${fileData.type}</p>
                        <p><strong>File Size:</strong> ${formatFileSize(fileData.size)}</p>
                        ${driveLink ? `<p><strong>Google Drive:</strong> ☁️ Available</p>` : ''}
                    </div>
                    <div>
                        <button onclick="openFile('${fileName}', '${attachmentName}')" class="download-link" style="margin-right: 10px;">
                            🔗 Open File
                        </button>
                        <button onclick="downloadFileFromPreview('${fileName}', '${attachmentName}')" class="download-link">
                            💾 Download File
                        </button>
                        ${driveLink ? `
                            <a href="${driveLink}" target="_blank" class="download-link" style="display: block; margin-top: 10px; background: #4285f4;">
                                ☁️ Open in Google Drive
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;


            const previewContent = document.getElementById('filePreviewContent');
            
            if (fileData.type === 'text/html' || fileName.includes('.html')) {
                previewContent.innerHTML = `
                    <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd;">
                            <strong>📄 HTML Document Preview</strong>
                        </div>
                        <iframe srcdoc="${fileData.content.replace(/"/g, '&quot;')}" 
                                style="width: 100%; height: 600px; border: none;"></iframe>
                    </div>
                `;
            }
            else if (fileData.type === 'image/svg+xml' || fileName.includes('.svg')) {
                previewContent.innerHTML = `
                    <div style="text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                        <div style="background: #f8f9fa; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
                            <strong>🎨 SVG Image Preview</strong>
                        </div>
                        <div style="max-width: 100%; overflow: auto;">
                            ${fileData.content}
                        </div>
                    </div>
                `;
            }
            else if (fileData.type.startsWith('image/') && !fileData.type.includes('svg')) {
                let imageSrc = '';
                if (fileData.content && fileData.content.startsWith('data:')) {
                    imageSrc = fileData.content;
                } else {
                    const blob = createFileBlob(fileName);
                    if (blob) {
                        imageSrc = URL.createObjectURL(blob);
                    }
                }
                
                if (imageSrc) {
                    previewContent.innerHTML = `
                        <div style="text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                            <div style="background: #f8f9fa; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
                                <strong>🖼️ Image Preview</strong>
                            </div>
                            <img src="${imageSrc}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" alt="${attachmentName}">
                        </div>
                    `;
                }
            }
            else if (fileData.type === 'application/pdf') {
                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="font-size: 4em; color: #dc3545; margin-bottom: 20px;">📄</div>
                        <h4>PDF Document</h4>
                        <p>PDF files cannot be previewed directly in this interface.</p>
                        <p><strong>File:</strong> ${attachmentName}</p>
                        <div style="margin-top: 20px;">
                            <button onclick="openFile('${fileName}', '${attachmentName}')" class="btn btn-primary" style="margin-right: 10px;">
                                🔗 Open PDF in New Tab
                            </button>
                            <button onclick="downloadFileFromPreview('${fileName}', '${attachmentName}')" class="btn btn-success">
                                💾 Download PDF
                            </button>
                            ${driveLink ? `
                                <a href="${driveLink}" target="_blank" class="btn btn-info" style="display: inline-block; margin-left: 10px;">
                                    ☁️ Open in Google Drive
                                </a>
                            ` : ''}
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">
                            Click "Open PDF in New Tab" to view the document in your browser's PDF viewer.
                        </p>
                    </div>
                `;
            }
            else {
                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="font-size: 4em; color: #6c757d; margin-bottom: 20px;">📄</div>
                        <h4>File Preview Not Available</h4>
                        <p>This file type cannot be previewed directly.</p>
                        <p><strong>File Type:</strong> ${fileData.type}</p>
                        <p><strong>File Name:</strong> ${attachmentName}</p>
                        <div style="margin-top: 20px;">
                            <button onclick="openFile('${fileName}', '${attachmentName}')" class="btn btn-primary" style="margin-right: 10px;">
                                🔗 Open File
                            </button>
                            <button onclick="downloadFileFromPreview('${fileName}', '${attachmentName}')" class="btn btn-success">
                                💾 Download File
                            </button>
                            ${driveLink ? `
                                <a href="${driveLink}" target="_blank" class="btn btn-info" style="display: inline-block; margin-left: 10px;">
                                    ☁️ Open in Google Drive
                                </a>
                            ` : ''}
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">
                            Use "Open File" to try viewing in a new tab, or download to view locally.
                        </p>
                    </div>
                `;
            }


            document.getElementById('filePreviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }


        function closeFilePreview() {
            document.getElementById('filePreviewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }


        function downloadFileFromPreview(fileName, attachmentName) {
            const blob = createFileBlob(fileName);
            if (!blob) {
                showNotification('File not available for download', 'error');
                return;
            }


            try {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = attachmentName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);


                showNotification(`Downloaded: ${attachmentName}`, 'success');
                addHistoryEntry('Document', 'download', 'File downloaded', `File "${attachmentName}" was downloaded from preview`);
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading file', 'error');
            }
        }


        function downloadFileFromAttachment(fileName, attachmentName) {
            const blob = createFileBlob(fileName);
            if (!blob) {
                showNotification('File not found', 'error');
                return;
            }


            try {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = attachmentName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);


                showNotification(`Downloaded: ${attachmentName}`, 'success');
                addHistoryEntry('Document', 'download', 'File downloaded', `File "${attachmentName}" was downloaded`);
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading file', 'error');
            }
        }


        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }


        // History Management
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">📜</div>
                        <div>No history entries found</div>
                        <p>System activities will appear here</p>
                    </div>
                `;
                return;
            }


            container.innerHTML = filteredHistory.slice().reverse().map(entry => `
                <div class="history-entry">
                    <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                    <div class="action">${getActionIcon(entry.action)} ${entry.type.toUpperCase()} - ${entry.action.toUpperCase()}</div>
                    <div class="details">${entry.details}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">User: ${entry.user}</div>
                </div>
            `).join('');
        }


        function getActionIcon(action) {
            const icons = {
                'create': '➕',
                'update': '✏️',
                'delete': '🗑️',
                'upload': '📤',
                'download': '💾',
                'view': '👁️',
                'export': '📊',
                'system_start': '🚀',
                'section_view': '🧭',
                'bulk_download': '📦',
                'edit': '✏️',
                'google_drive_connect': '☁️',
                'sync': '🔄',
                'backup': '💾',
                'restore': '📥',
                'data_load': '📊'
            };
            return icons[action] || '📝';
        }


        // Job Card Management (Enhanced with Google Drive)
        function openJobCardModal() {
            clearJobCardForm();
            populateJobCardDropdowns();
            document.getElementById('jobCardModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }


        function closeJobCardModal() {
            document.getElementById('jobCardModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }


        function clearJobCardForm() {
            document.getElementById('jobCardCategory').value = '';
            document.getElementById('jobCardSubCategory').value = '';
            document.getElementById('jobCardBulkFile').value = '';
            document.getElementById('jobCardTableHeader').innerHTML = '';
            document.getElementById('jobCardTableBody').innerHTML = '';
        }


        function populateJobCardDropdowns() {
            const categorySelect = document.getElementById('jobCardCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' +
                systemData.categories.filter(cat => cat.status === 'active').map(category => 
                    `<option value="${category.id}">${category.name}</option>`
                ).join('');
        }


        function updateJobCardSubCategories() {
            const categoryId = document.getElementById('jobCardCategory').value;
            const subCategorySelect = document.getElementById('jobCardSubCategory');
            
            if (!categoryId) {
                subCategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
                document.getElementById('jobCardTableHeader').innerHTML = '';
                document.getElementById('jobCardTableBody').innerHTML = '';
                return;
            }


            const selectedCategory = systemData.categories.find(c => c.id === categoryId);
            
            const relatedSubCategories = systemData.categories
                .filter(c => c.name === selectedCategory?.name && c.subCategory)
                .map(c => c.subCategory)
                .filter((value, index, self) => self.indexOf(value) === index);


            subCategorySelect.innerHTML = '<option value="">Select Sub-Category</option>' +
                relatedSubCategories.map(sub => `<option value="${sub}">${sub}</option>`).join('');


            if (selectedCategory && selectedCategory.tableColumns) {
                updateJobCardTableHeaders(selectedCategory.tableColumns);
            }
        }


        function updateJobCardTableHeaders(columns) {
            const tableHeader = document.getElementById('jobCardTableHeader');
            
            tableHeader.innerHTML = `
                <tr>
                    <th style="min-width: 150px;">Reference</th>
                    ${columns.filter(col => col !== 'Code' && col !== 'Files').map(col => `
                        <th style="min-width: 120px;">${col}</th>
                    `).join('')}
                    <th class="upload-cell" style="min-width: 150px;">Upload Files</th>
                    <th style="min-width: 80px;">Actions</th>
                </tr>
            `;


            document.getElementById('jobCardTableBody').innerHTML = '';
            addJobCardRow();
        }


        function addJobCardRow() {
            const categoryId = document.getElementById('jobCardCategory').value;
            if (!categoryId) {
                showNotification('Please select a category first', 'error');
                return;
            }


            const category = systemData.categories.find(c => c.id === categoryId);
            if (!category || !category.tableColumns) {
                showNotification('Category not found or no table columns defined', 'error');
                return;
            }


            const tbody = document.getElementById('jobCardTableBody');
            const rowIndex = tbody.children.length;
            const dataColumns = category.tableColumns.filter(col => col !== 'Code' && col !== 'Files');
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="data-input" style="width: 100%;" onchange="autoFillItemDetails(this, ${rowIndex})">
                        <option value="">Select Item</option>
                        ${systemData.items.filter(item => item.status === 'active').map(item => 
                            `<option value="${item.id}" 
                                data-name="${item.name}" 
                                data-collection="${item.collection || ''}" 
                                data-brand="${item.brand}" 
                                data-description="${item.description || ''}"
                            >${item.code} - ${item.name}</option>`
                        ).join('')}
                    </select>
                </td>
                ${dataColumns.map(col => `
                    <td>
                        <input type="text" class="data-input" placeholder="Enter ${col}..." data-column="${col}" style="width: 100%;" id="input_${rowIndex}_${col.replace(/\s+/g, '_')}">
                    </td>
                `).join('')}
                <td class="upload-cell">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <input type="file" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" 
                               onchange="handleFileSelect(event, ${rowIndex})" style="font-size: 10px;">
                        <input type="url" placeholder="Or paste file link..." class="data-input" style="font-size: 10px;">
                        <div class="file-list" id="fileList_${rowIndex}" style="font-size: 10px;"></div>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="removeJobCardRow(this)" style="font-size: 10px;">🗑️</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }


        function autoFillItemDetails(selectElement, rowIndex) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (!selectedOption.value) return;


            const itemData = {
                name: selectedOption.getAttribute('data-name'),
                collection: selectedOption.getAttribute('data-collection'),
                brand: selectedOption.getAttribute('data-brand'),
                description: selectedOption.getAttribute('data-description')
            };


            const autoFillMapping = {
                'Item Name': 'name',
                'Name': 'name', 
                'Item': 'name',
                'Collection': 'collection',
                'Brand': 'brand',
                'Description': 'description'
            };


            Object.entries(autoFillMapping).forEach(([columnName, dataKey]) => {
                const input = document.getElementById(`input_${rowIndex}_${columnName.replace(/\s+/g, '_')}`);
                if (input && itemData[dataKey]) {
                    input.value = itemData[dataKey];
                }
            });
        }


        function removeJobCardRow(button) {
            const row = button.closest('tr');
            if (confirm('Are you sure you want to remove this row?')) {
                row.remove();
            }
        }


        function removeFileFromList(button, fileName) {
            delete systemData.files[fileName];
            button.parentElement.remove();
        }


        function processBulkFile() {
            const fileInput = document.getElementById('jobCardBulkFile');
            const file = fileInput.files[0];
            
            if (!file) return;


            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    document.getElementById('jobCardTableBody').innerHTML = '';
                    
                    jsonData.forEach((row, index) => {
                        addJobCardRowFromData(row);
                    });
                    
                    showNotification(`Loaded ${jsonData.length} items from spreadsheet`, 'success');
                } catch (error) {
                    showNotification('Error processing spreadsheet', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }


        function addJobCardRowFromData(data) {
            const categoryId = document.getElementById('jobCardCategory').value;
            if (!categoryId) return;


            const category = systemData.categories.find(c => c.id === categoryId);
            if (!category || !category.tableColumns) return;


            const tbody = document.getElementById('jobCardTableBody');
            const rowIndex = tbody.children.length;
            const dataColumns = category.tableColumns.filter(col => col !== 'Code' && col !== 'Files');
            
            const itemCode = data['Item Code'] || data['Code'] || '';
            const item = systemData.items.find(i => i.code === itemCode);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="data-input" style="width: 100%;" onchange="autoFillItemDetails(this, ${rowIndex})">
                        <option value="">Select Item</option>
                        ${systemData.items.filter(item => item.status === 'active').map(item => 
                            `<option value="${item.id}" ${item.code === itemCode ? 'selected' : ''}
                                data-name="${item.name}" 
                                data-collection="${item.collection || ''}" 
                                data-brand="${item.brand}" 
                                data-description="${item.description || ''}"
                            >${item.code} - ${item.name}</option>`
                        ).join('')}
                    </select>
                </td>
                ${dataColumns.map(col => `
                    <td>
                        <input type="text" class="data-input" 
                               value="${data[col] || ''}"
                               placeholder="Enter ${col}..." 
                               data-column="${col}" 
                               style="width: 100%;"
                               id="input_${rowIndex}_${col.replace(/\s+/g, '_')}">
                    </td>
                `).join('')}
                <td class="upload-cell">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <input type="file" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" 
                               onchange="handleFileSelect(event, ${rowIndex})" style="font-size: 10px;">
                        <input type="url" placeholder="Or paste file link..." class="data-input" 
                               value="${data['File Link'] || ''}" style="font-size: 10px;">
                        <div class="file-list" id="fileList_${rowIndex}" style="font-size: 10px;"></div>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="removeJobCardRow(this)" style="font-size: 10px;">🗑️</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }


        function saveJobCard() {
            const categoryId = document.getElementById('jobCardCategory').value;
            const subCategory = document.getElementById('jobCardSubCategory').value;
            
            if (!categoryId) {
                showNotification('Please select a category', 'error');
                return;
            }


            const category = systemData.categories.find(c => c.id === categoryId);
            if (!category) {
                showNotification('Category not found', 'error');
                return;
            }


            const tbody = document.getElementById('jobCardTableBody');
            const rows = Array.from(tbody.children);
            
            if (rows.length === 0) {
                showNotification('Please add at least one row', 'error');
                return;
            }


            const jobCardId = 'job_' + Date.now();
            const jobNumber = `JOB-2025-${systemData.jobCards.length + 1}`.padStart(12, '0');


            const jobCardData = {
                id: jobCardId,
                jobNumber: jobNumber,
                categoryId: categoryId,
                subCategory: subCategory,
                tableColumns: category.tableColumns,
                createdDate: new Date().toISOString(),
                createdBy: currentUser.name,
                status: 'active',
                rows: []
            };


            let documentsCreated = 0;


            rows.forEach((row, index) => {
                const cells = row.children;
                const itemSelect = cells[0].querySelector('select');
                const itemId = itemSelect.value;
                
                if (itemId) {
                    const dataColumns = category.tableColumns.filter(col => col !== 'Code' && col !== 'Files');
                    const rowData = {
                        itemId: itemId,
                        data: {}
                    };
                    
                    dataColumns.forEach((col, i) => {
                        const input = cells[i + 1].querySelector('input');
                        if (input && input.value.trim()) {
                            rowData.data[col] = input.value.trim();
                        }
                    });
                    
                    const fileInput = cells[cells.length - 2].querySelector('input[type="file"]');
                    const linkInput = cells[cells.length - 2].querySelector('input[type="url"]');
                    
                    const fileList = cells[cells.length - 2].querySelector('.file-list');
                    const files = fileList ? Array.from(fileList.children).map(item => 
                        item.querySelector('span').textContent
                    ) : [];
                    
                    rowData.files = files;
                    rowData.link = linkInput.value.trim();
                    
                    jobCardData.rows.push(rowData);
                    
                    files.forEach(fileName => {
                        const doc = {
                            id: 'doc_' + Date.now() + '_' + Math.random(),
                            name: fileName,
                            categoryId: categoryId,
                            itemId: itemId,
                            fileType: getFileType(fileName),
                            metadata: rowData.data,
                            uploadedBy: currentUser.name,
                            uploadDate: new Date().toISOString(),
                            jobCardId: jobCardId,
                            filePath: fileName,
                            attachments: [
                                {
                                    id: 'att_' + Date.now() + '_' + Math.random(),
                                    name: fileName,
                                    type: getFileType(fileName),
                                    url: fileName,
                                    size: systemData.files[fileName] ? formatFileSize(systemData.files[fileName].size) : 'Unknown'
                                }
                            ]
                        };
                        systemData.documents.push(doc);
                        documentsCreated++;
                    });
                    
                    if (linkInput.value.trim()) {
                        const doc = {
                            id: 'doc_' + Date.now() + '_' + Math.random(),
                            name: `Linked_Document_${index + 1}`,
                            categoryId: categoryId,
                            itemId: itemId,
                            fileType: 'LINK',
                            metadata: rowData.data,
                            uploadedBy: currentUser.name,
                            uploadDate: new Date().toISOString(),
                            jobCardId: jobCardId,
                            filePath: linkInput.value.trim(),
                            attachments: [
                                {
                                    id: 'att_' + Date.now() + '_' + Math.random(),
                                    name: `Linked_Document_${index + 1}`,
                                    type: 'LINK',
                                    url: linkInput.value.trim(),
                                    size: 'External Link'
                                }
                            ]
                        };
                        systemData.documents.push(doc);
                        documentsCreated++;
                    }
                }
            });


            systemData.jobCards.push(jobCardData);
            filteredDocuments = [...systemData.documents];
            filteredJobCards = [...systemData.jobCards];
            
            updateAllStatistics();
            updateJobCardDataLists();
            renderJobCards();
            closeJobCardModal();
            
            addHistoryEntry('Job Card', 'create', 'Job card created', 
                `Job card ${jobNumber} created with ${documentsCreated} documents`);
            showNotification(`Job card ${jobNumber} created with ${documentsCreated} documents`, 'success');
            
            // Trigger auto-save
            scheduleAutoSave();
        }


        function renderJobCards() {
            const container = document.getElementById('jobCardsList');
            
            if (filteredJobCards.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">💼</div>
                        <div>No job cards found</div>
                        <p>Create job cards to organize document uploads</p>
                    </div>
                `;
                return;
            }


            container.innerHTML = filteredJobCards.map(jobCard => {
                const category = systemData.categories.find(c => c.id === jobCard.categoryId);
                const documentsCount = systemData.documents.filter(doc => doc.jobCardId === jobCard.id).length;
                const jobNumber = jobCard.jobNumber || `JOB-${jobCard.id}`;
                
                return `
                    <div class="job-card">
                        <div class="job-card-header">
                            <div>
                                <h3>${jobNumber}</h3>
                                <div style="margin-top: 8px;">
                                    <span class="badge badge-primary">${category ? category.name : 'Unknown Category'}</span>
                                    ${jobCard.subCategory ? `<span class="badge badge-secondary">${jobCard.subCategory}</span>` : ''}
                                    <span class="badge badge-${getStatusBadgeColor(jobCard.status || 'active')}">${(jobCard.status || 'active').toUpperCase()}</span>
                                </div>
                                ${category && category.tableColumns ? `
                                    <div style="margin-top: 10px;">
                                        <strong>Table Format:</strong> ${category.tableColumns.map(col => `<span class="badge badge-info" style="margin: 2px;">${col}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="job-card-actions">
                                <button class="btn btn-primary" onclick="viewJobCardDocuments('${jobCard.id}')" title="View Documents">📄 ${documentsCount}</button>
                                <button class="btn btn-warning" onclick="viewJobCardDetails('${jobCard.id}')" title="View Details">👁️</button>
                                <button class="btn btn-info" onclick="openEditJobCardModal('${jobCard.id}')" title="Edit Job Card">✏️ Edit</button>
                                <button class="btn btn-danger" onclick="deleteJobCard('${jobCard.id}')" title="Delete">🗑️</button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <strong>Items (${jobCard.rows.length}):</strong>
                            <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                                ${jobCard.rows.map(row => {
                                    const item = systemData.items.find(i => i.id === row.itemId);
                                    return item ? `<span class="badge badge-${item.status === 'active' ? 'info' : 'secondary'}">${item.code}</span>` : '';
                                }).filter(badge => badge).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 12px; color: #666;">
                            <div>
                                <div>Created by ${jobCard.createdBy}</div>
                                <div>${new Date(jobCard.createdDate).toLocaleDateString()}</div>
                                ${jobCard.lastModified ? `<div>Modified: ${new Date(jobCard.lastModified).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        function getStatusBadgeColor(status) {
            const colors = {
                'active': 'success',
                'inactive': 'secondary',
                'completed': 'primary',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }


        function viewJobCardDetails(jobCardId) {
            const jobCard = systemData.jobCards.find(jc => jc.id === jobCardId);
            if (!jobCard) return;


            const category = systemData.categories.find(c => c.id === jobCard.categoryId);
            const tableColumns = category ? category.tableColumns : [];
            const dataColumns = tableColumns.filter(col => col !== 'Code' && col !== 'Files');
            const jobNumber = jobCard.jobNumber || `JOB-${jobCard.id}`;
            
            let detailsHtml = `
                <h3>${jobNumber} Details</h3>
                <p><strong>Category:</strong> ${category ? category.name : 'Unknown'}</p>
                <p><strong>Sub-Category:</strong> ${jobCard.subCategory || 'None'}</p>
                <p><strong>Status:</strong> <span class="badge badge-${getStatusBadgeColor(jobCard.status || 'active')}">${(jobCard.status || 'active').toUpperCase()}</span></p>
                <p><strong>Table Format:</strong> ${tableColumns.join(', ') || 'None'}</p>
                <p><strong>Created:</strong> ${new Date(jobCard.createdDate).toLocaleString()}</p>
                <p><strong>Created By:</strong> ${jobCard.createdBy}</p>
                ${jobCard.lastModified ? `<p><strong>Last Modified:</strong> ${new Date(jobCard.lastModified).toLocaleString()} by ${jobCard.modifiedBy}</p>` : ''}
                
                <h4>Data Rows:</h4>
                <table class="data-table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Status</th>
                            ${dataColumns.map(col => `<th>${col}</th>`).join('')}
                            <th>Files</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jobCard.rows.map(row => {
                            const item = systemData.items.find(i => i.id === row.itemId);
                            const rowClass = item && item.status === 'inactive' ? 'inactive-item' : '';
                            return `
                                <tr class="${rowClass}">
                                    <td>${item ? item.code : 'Unknown'}</td>
                                    <td><span class="badge badge-${item && item.status === 'active' ? 'success' : 'secondary'}">${item ? (item.status || 'active') : 'Unknown'}</span></td>
                                    ${dataColumns.map(col => `<td>${row.data[col] || '-'}</td>`).join('')}
                                    <td>
                                        ${row.files && row.files.length > 0 ? row.files.join(', ') : ''}
                                        ${row.link ? `<br><a href="${row.link}" target="_blank">Link</a>` : ''}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            const detailModal = document.createElement('div');
            detailModal.className = 'modal';
            detailModal.style.display = 'block';
            detailModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Job Card Details</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove(); document.body.style.overflow = 'auto';">×</button>
                    </div>
                    <div class="modal-body">
                        ${detailsHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(detailModal);
            document.body.style.overflow = 'hidden';
        }


        function viewJobCardDocuments(jobCardId) {
            const jobCard = systemData.jobCards.find(jc => jc.id === jobCardId);
            if (!jobCard) return;


            const jobDocuments = systemData.documents.filter(doc => doc.jobCardId === jobCardId);
            
            filteredDocuments = jobDocuments;
            showSection('documents');
            
            const category = systemData.categories.find(c => c.id === jobCard.categoryId);
            if (category) {
                document.getElementById('docCategoryFilter').value = category.name;
                updateDocumentFilters();
            }
            
            renderDocuments();
            showNotification(`Showing ${jobDocuments.length} documents from job card`, 'info');
        }


        function deleteJobCard(jobCardId) {
            const jobCard = systemData.jobCards.find(jc => jc.id === jobCardId);
            if (!jobCard) return;


            const relatedDocs = systemData.documents.filter(doc => doc.jobCardId === jobCardId);
            const jobNumber = jobCard.jobNumber || `JOB-${jobCard.id}`;
            
            if (confirm(`Are you sure you want to delete ${jobNumber}? This will also delete ${relatedDocs.length} related documents.`)) {
                systemData.documents = systemData.documents.filter(doc => doc.jobCardId !== jobCardId);
                systemData.jobCards = systemData.jobCards.filter(jc => jc.id !== jobCardId);
                
                filteredDocuments = [...systemData.documents];
                filteredJobCards = [...systemData.jobCards];
                updateAllStatistics();
                updateJobCardDataLists();
                renderJobCards();
                
                addHistoryEntry('Job Card', 'delete', 'Job card deleted', `${jobNumber} and ${relatedDocs.length} documents were deleted`);
                showNotification(`${jobNumber} and ${relatedDocs.length} documents deleted successfully`, 'warning');
                
                // Trigger auto-save
                scheduleAutoSave();
            }
        }


        // Filter Functions
        function applyCategoryFilters() {
            const typeFilter = document.getElementById('categoryTypeFilter').value;
            const statusFilter = document.getElementById('categoryStatusFilter').value;
            const searchFilter = document.getElementById('categorySearchFilter').value.toLowerCase();


            filteredCategories = systemData.categories.filter(category => {
                const typeMatch = !typeFilter || category.type === typeFilter;
                const statusMatch = !statusFilter || category.status === statusFilter;
                const searchMatch = !searchFilter || 
                    category.name.toLowerCase().includes(searchFilter) ||
                    category.description.toLowerCase().includes(searchFilter) ||
                    (category.subCategory && category.subCategory.toLowerCase().includes(searchFilter));


                return typeMatch && statusMatch && searchMatch;
            });


            renderCategories();
            showNotification(`Found ${filteredCategories.length} categories`, 'info');
        }


        function clearCategoryFilters() {
            document.getElementById('categoryTypeFilter').value = '';
            document.getElementById('categoryStatusFilter').value = '';
            document.getElementById('categorySearchFilter').value = '';
            filteredCategories = [...systemData.categories];
            renderCategories();
        }


        function applyItemFilters() {
            const groupFilter = document.getElementById('itemGroupFilter').value.toLowerCase();
            const brandFilter = document.getElementById('itemBrandFilter').value.toLowerCase();
            const collectionFilter = document.getElementById('itemCollectionFilter').value.toLowerCase();
            const codeFilter = document.getElementById('itemCodeFilter').value.toLowerCase();
            const nameFilter = document.getElementById('itemNameFilter').value.toLowerCase();
            const volumeFilter = document.getElementById('itemVolumeFilter').value.toLowerCase();


            filteredItems = systemData.items.filter(item => {
                const groupMatch = !groupFilter || item.group.toLowerCase().includes(groupFilter);
                const brandMatch = !brandFilter || item.brand.toLowerCase().includes(brandFilter);
                const collectionMatch = !collectionFilter || (item.collection && item.collection.toLowerCase().includes(collectionFilter));
                const codeMatch = !codeFilter || item.code.toLowerCase().includes(codeFilter);
                const nameMatch = !nameFilter || item.name.toLowerCase().includes(nameFilter);
                const volumeMatch = !volumeFilter || (item.volume && item.volume.toLowerCase().includes(volumeFilter));


                return groupMatch && brandMatch && collectionMatch && codeMatch && nameMatch && volumeMatch;
            });


            renderItems();
            showNotification(`Found ${filteredItems.length} items`, 'info');
        }


        function clearItemFilters() {
            ['itemGroupFilter', 'itemBrandFilter', 'itemCollectionFilter', 'itemCodeFilter', 'itemNameFilter', 'itemVolumeFilter'].forEach(id => {
                document.getElementById(id).value = '';
            });
            filteredItems = [...systemData.items];
            renderItems();
        }


        function applyDocumentFilters() {
            const categoryFilter = document.getElementById('docCategoryFilter').value.toLowerCase();
            const subCategoryFilter = document.getElementById('docSubCategoryFilter').value.toLowerCase();
            const codeFilter = document.getElementById('docCodeFilter').value.toLowerCase();


            const itemFilters = multiSelectData.docItemFilter || [];
            const brandFilters = multiSelectData.docBrandFilter || [];
            const collectionFilters = multiSelectData.docCollectionFilter || [];


            const additionalFilters = {};
            const additionalFilterInputs = document.querySelectorAll('#additionalFilters input[type="text"]');
            additionalFilterInputs.forEach(input => {
                if (input.value.trim()) {
                    const columnName = input.id.replace('additional_', '').replace(/_/g, ' ');
                    additionalFilters[columnName] = input.value.toLowerCase();
                }
            });


            filteredDocuments = systemData.documents.filter(doc => {
                const category = systemData.categories.find(c => c.id === doc.categoryId);
                const item = systemData.items.find(i => i.id === doc.itemId);


                const categoryMatch = !categoryFilter || (category && category.name.toLowerCase().includes(categoryFilter));
                const subCategoryMatch = !subCategoryFilter || (category?.subCategory && category.subCategory.toLowerCase().includes(subCategoryFilter));
                const codeMatch = !codeFilter || (item && item.code.toLowerCase().includes(codeFilter));
                
                const itemMatch = itemFilters.length === 0 || (item && itemFilters.some(filter => item.name.toLowerCase().includes(filter.toLowerCase())));
                const brandMatch = brandFilters.length === 0 || (item && brandFilters.some(filter => item.brand.toLowerCase().includes(filter.toLowerCase())));
                const collectionMatch = collectionFilters.length === 0 || (item?.collection && collectionFilters.some(filter => item.collection.toLowerCase().includes(filter.toLowerCase())));


                let additionalMatch = true;
                if (Object.keys(additionalFilters).length > 0) {
                    for (const [columnName, filterValue] of Object.entries(additionalFilters)) {
                        const documentValue = doc.metadata && doc.metadata[columnName];
                        if (!documentValue || !documentValue.toLowerCase().includes(filterValue)) {
                            additionalMatch = false;
                            break;
                        }
                    }
                }


                return categoryMatch && subCategoryMatch && codeMatch && itemMatch && 
                       brandMatch && collectionMatch && additionalMatch;
            });


            renderDocuments();
            showNotification(`Found ${filteredDocuments.length} documents`, 'info');
        }


        function clearDocumentFilters() {
            [
                'docCategoryFilter', 'docSubCategoryFilter', 'docCodeFilter'
            ].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            multiSelectData.docItemFilter = [];
            multiSelectData.docBrandFilter = [];
            multiSelectData.docCollectionFilter = [];
            
            updateMultiSelectDisplay('docItemFilter');
            updateMultiSelectDisplay('docBrandFilter');
            updateMultiSelectDisplay('docCollectionFilter');
            
            const additionalFilterInputs = document.querySelectorAll('#additionalFilters input[type="text"]');
            additionalFilterInputs.forEach(input => {
                input.value = '';
            });
            
            document.getElementById('additionalFilters').classList.add('hidden');
            
            filteredDocuments = [...systemData.documents];
            renderDocuments();
        }


        function applyJobCardFilters() {
            const jobNumberFilter = document.getElementById('jobCardNumberFilter').value.toLowerCase();
            const userNameFilter = document.getElementById('jobCardUserFilter').value.toLowerCase();
            const itemNameFilter = document.getElementById('jobCardItemNameFilter').value.toLowerCase();
            const itemCodeFilter = document.getElementById('jobCardItemCodeFilter').value.toLowerCase();


            filteredJobCards = systemData.jobCards.filter(jobCard => {
                const jobNumber = jobCard.jobNumber || `JOB-${jobCard.id}`;
                const jobNumberMatch = !jobNumberFilter || jobNumber.toLowerCase().includes(jobNumberFilter);
                const userMatch = !userNameFilter || jobCard.createdBy.toLowerCase().includes(userNameFilter);
                
                let itemNameMatch = !itemNameFilter;
                let itemCodeMatch = !itemCodeFilter;
                
                if (itemNameFilter || itemCodeFilter) {
                    jobCard.rows.forEach(row => {
                        const item = systemData.items.find(i => i.id === row.itemId);
                        if (item) {
                            if (itemNameFilter && item.name.toLowerCase().includes(itemNameFilter)) {
                                itemNameMatch = true;
                            }
                            if (itemCodeFilter && item.code.toLowerCase().includes(itemCodeFilter)) {
                                itemCodeMatch = true;
                            }
                        }
                    });
                }


                return jobNumberMatch && userMatch && itemNameMatch && itemCodeMatch;
            });


            renderJobCards();
            showNotification(`Found ${filteredJobCards.length} job cards`, 'info');
        }


        function clearJobCardFilters() {
            ['jobCardNumberFilter', 'jobCardUserFilter', 'jobCardItemNameFilter', 'jobCardItemCodeFilter'].forEach(id => {
                document.getElementById(id).value = '';
            });
            filteredJobCards = [...systemData.jobCards];
            renderJobCards();
        }


        function applyHistoryFilters() {
            const actionFilter = document.getElementById('historyActionFilter').value;
            const userFilter = document.getElementById('historyUserFilter').value.toLowerCase();
            const dateFromFilter = document.getElementById('historyDateFromFilter').value;
            const dateToFilter = document.getElementById('historyDateToFilter').value;
            const searchFilter = document.getElementById('historySearchFilter').value.toLowerCase();


            filteredHistory = systemData.history.filter(entry => {
                const actionMatch = !actionFilter || entry.action === actionFilter;
                const userMatch = !userFilter || entry.user.toLowerCase().includes(userFilter);
                const searchMatch = !searchFilter || 
                    entry.details.toLowerCase().includes(searchFilter) ||
                    entry.type.toLowerCase().includes(searchFilter);


                let dateMatch = true;
                if (dateFromFilter || dateToFilter) {
                    const entryDate = new Date(entry.timestamp).toDateString();
                    const fromDate = dateFromFilter ? new Date(dateFromFilter).toDateString() : null;
                    const toDate = dateToFilter ? new Date(dateToFilter).toDateString() : null;
                    
                    if (fromDate && entryDate < fromDate) dateMatch = false;
                    if (toDate && entryDate > toDate) dateMatch = false;
                }


                return actionMatch && userMatch && dateMatch && searchMatch;
            });


            renderHistory();
            showNotification(`Found ${filteredHistory.length} history entries`, 'info');
        }


        function clearHistoryFilters() {
            ['historyActionFilter', 'historyUserFilter', 'historyDateFromFilter', 'historyDateToFilter', 'historySearchFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element.type === 'select-one') {
                    element.selectedIndex = 0;
                } else {
                    element.value = '';
                }
            });
            filteredHistory = [...systemData.history];
            renderHistory();
        }


        function downloadFilteredDocuments() {
            if (filteredDocuments.length === 0) {
                showNotification('No documents to download', 'warning');
                return;
            }
            
            let downloadCount = 0;
            filteredDocuments.forEach(doc => {
                if (doc.attachments && doc.attachments.length > 0) {
                    doc.attachments.forEach((attachment, index) => {
                        setTimeout(() => {
                            downloadFileFromAttachment(attachment.url, attachment.name);
                        }, downloadCount * 800);
                        downloadCount++;
                    });
                }
            });
            
            if (downloadCount > 0) {
                showNotification(`Starting download of ${downloadCount} files...`, 'info');
                addHistoryEntry('Document', 'bulk_download', 'Bulk download', `${downloadCount} documents downloaded`);
            } else {
                showNotification('No files available for download', 'warning');
            }
        }


        function exportFilteredDocuments() {
            if (filteredDocuments.length === 0) {
                showNotification('No documents to export', 'warning');
                return;
            }


            const exportData = filteredDocuments.map(doc => {
                const category = systemData.categories.find(c => c.id === doc.categoryId);
                const item = systemData.items.find(i => i.id === doc.itemId);
                const jobCard = systemData.jobCards.find(jc => jc.id === doc.jobCardId);
                
                const baseData = {
                    'Job Card No.': jobCard ? (jobCard.jobNumber || `JOB-${jobCard.id}`) : '-',
                    'Category': category ? category.name : 'Unknown',
                    'Sub-Category': category?.subCategory || '-',
                    'Item Code': item ? item.code : 'Unknown',
                    'Item Name': item ? item.name : 'Unknown',
                    'Item Status': item ? (item.status || 'active') : 'Unknown',
                    'File Type': doc.fileType,
                    'Upload Date': new Date(doc.uploadDate).toLocaleDateString(),
                    'Uploaded By': doc.uploadedBy,
                    'File Link': doc.filePath || '-',
                    'Attachments Count': doc.attachments ? doc.attachments.length : 0
                };


                if (doc.metadata) {
                    Object.keys(doc.metadata).forEach(key => {
                        baseData[key] = doc.metadata[key];
                    });
                }


                return baseData;
            });


            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Documents');
            
            const fileName = `documents_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            addHistoryEntry('Document', 'export', 'Documents exported', `${filteredDocuments.length} documents exported to Excel`);
            showNotification(`Exported ${filteredDocuments.length} documents to Excel`, 'success');
        }


        // Event Listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });


        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    if (modal.id === 'filePreviewModal') {
                        closeFilePreview();
                    } else {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                }
            });
        });


        window.addEventListener('error', function(event) {
            console.error('System error:', event.error);
            addHistoryEntry('System', 'error', 'System error', `Error: ${event.error.message}`);
            showNotification('A system error occurred. Check console for details.', 'error');
        });


        // Configuration warning for Google Drive
        window.addEventListener('load', function() {
            // Check if Google Drive configuration is set
            if (GOOGLE_DRIVE_CONFIG.CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID' || 
                GOOGLE_DRIVE_CONFIG.API_KEY === 'YOUR_GOOGLE_API_KEY') {
                
                console.warn('⚠️ Google Drive not configured. Please set your CLIENT_ID and API_KEY in the GOOGLE_DRIVE_CONFIG object.');
                
                setTimeout(() => {
                    if (confirm('Google Drive integration requires configuration. Would you like to see the setup instructions?')) {
                        alert(`To enable Google Drive integration:


1. Go to Google Cloud Console (https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable Google Drive API
4. Create credentials (API Key and OAuth 2.0 Client ID)
5. Replace the placeholders in GOOGLE_DRIVE_CONFIG:
   - CLIENT_ID: Your Google OAuth 2.0 Client ID
   - API_KEY: Your Google API Key


For detailed instructions, visit:
https://developers.google.com/drive/api/quickstart/js`);
                    }
                }, 3000);
            }
        });


        console.log('✅ Professional Documentation Management System with Google Drive Integration loaded successfully!');
    </script>
</body>
</html>
